<!DOCTYPE html><html lang=zh-CN><head><title>独特的 DNS 配置 - ShiuxのBlog</title><meta charset=UTF-8><meta name=keywords content=""><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><link rel="shortcut icon" href=/logo.svg type=image/x-icon><meta name=description content="众所周知，DNS 的作用与电话簿类似，将人类可读的域名映射到机器可读 IP 地址、使人更方便地访问互联网。DNS 是非常重要的互联网基础设施，对于改善上网冲浪的体验中的重要程度不容小觑。 避免不必要的 DNS 解析 如果想要通过优化 DNS 来改善自己的网络体验，第一步其实是避免不必要的 DNS 解析。 使用 Fake IP 避免本机 DNS 解析 对于不支持设置 SOCKS&#x2F;HTTP (S) 代"><meta property=og:type content=article><meta property=og:title content="独特的 DNS 配置"><meta property=og:url content=https://blog.shiux.com/article/unique-dns-setup/index.html><meta property=og:site_name content=ShiuxのBlog><meta property=og:description content="众所周知，DNS 的作用与电话簿类似，将人类可读的域名映射到机器可读 IP 地址、使人更方便地访问互联网。DNS 是非常重要的互联网基础设施，对于改善上网冲浪的体验中的重要程度不容小觑。 避免不必要的 DNS 解析 如果想要通过优化 DNS 来改善自己的网络体验，第一步其实是避免不必要的 DNS 解析。 使用 Fake IP 避免本机 DNS 解析 对于不支持设置 SOCKS&#x2F;HTTP (S) 代"><meta property=og:locale content=zh_CN><meta property=og:image content=https://s1.ax1x.com/2023/02/17/pSqQy9K.png><meta property=og:image content=https://s1.ax1x.com/2023/02/17/pSqQ61O.png><meta property=og:image content=https://s1.ax1x.com/2023/02/17/pSqQfHA.png><meta property=og:image content=https://s1.ax1x.com/2023/02/17/pSqQHgS.png><meta property=og:image content=https://s1.ax1x.com/2023/02/17/pSqlCgU.png><meta property=article:published_time content=2020-02-23T11:22:04.000Z><meta property=article:modified_time content=2023-02-22T15:26:41.191Z><meta property=article:author content=Shiux><meta property=article:tag content=技巧><meta property=article:tag content=IP><meta property=article:tag content=DNS><meta property=article:tag content=MacOS><meta name=twitter:card content=summary><meta name=twitter:image content=https://s1.ax1x.com/2023/02/17/pSqQy9K.png><link rel=stylesheet href=/lib/fancybox/fancybox.css><link rel=stylesheet href=/lib/mdui_043tiny/mdui.css><link rel=stylesheet href="/lib/iconfont/iconfont.css?v=1677079625816"><link rel=stylesheet href="/css/style.css?v=1677079625816"><link rel=stylesheet href="/custom.css?v=1677079625816"><meta name=generator content="Hexo 6.3.0"></head><body class=mdui-drawer-body-left><div id=nexmoe-background><div class=nexmoe-bg style=background-image:url(https://api.ixiaowai.cn/api/api.php)></div><div class="mdui-appbar mdui-shadow-0"><div class=mdui-toolbar><a mdui-drawer="{target: '#drawer', swipe: true}" title=menu class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a><div class=mdui-toolbar-spacer></div><a href=/ title=Shiux class="mdui-btn mdui-btn-icon"><img src=/logo.svg alt=Shiux></a></div></div></div><div id=nexmoe-header><div class="nexmoe-drawer mdui-drawer" id=drawer><div class="nexmoe-avatar mdui-ripple"><a href=/ title=Shiux><img src=/logo.svg alt=Shiux alt=Shiux></a></div><div class=nexmoe-count><div><span>文章</span>48</div><div><span>标签</span>34</div><div><span>分类</span>7</div></div><div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}"><a class="nexmoe-list-item mdui-list-item mdui-ripple false" href=/ title=回到首页><i class="mdui-list-item-icon nexmoefont icon-home"></i><div class=mdui-list-item-content>回到首页</div></a><a class="nexmoe-list-item mdui-list-item mdui-ripple false" href=/archive.html title=文章归档><i class="mdui-list-item-icon nexmoefont icon-container"></i><div class=mdui-list-item-content>文章归档</div></a><a class="nexmoe-list-item mdui-list-item mdui-ripple false" href=/about.html title=关于博主><i class="mdui-list-item-icon nexmoefont icon-info-circle"></i><div class=mdui-list-item-content>关于博主</div></a></div><aside id=nexmoe-sidebar><div class=nexmoe-widget-wrap><div class="nexmoe-widget nexmoe-social"><a class=mdui-ripple href=https://github.com/shiucs/ target=_blank mdui-tooltip="{content: 'GitHub'}" style=color:#191717;background-color:rgba(25,23,23,.1)><i class="nexmoefont icon-github"></i> </a><a class=mdui-ripple href=https://www.zhihu.com/people/fungyua target=_blank mdui-tooltip="{content: '知乎'}" style=color:#1e88e5;background-color:rgba(30,136,229,.1)><i class="nexmoefont icon-zhihu"></i></a></div></div><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>文章分类</h3><div class=nexmoe-widget><ul class=category-list><li class=category-list-item><a class=category-list-link href=/categories/Code/ >Code</a> <span class=category-list-count>19</span></li><li class=category-list-item><a class=category-list-link href=/categories/Guide/ >Guide</a> <span class=category-list-count>12</span></li><li class=category-list-item><a class=category-list-link href=/categories/Linux/ >Linux</a> <span class=category-list-count>5</span></li><li class=category-list-item><a class=category-list-link href=/categories/MacOS/ >MacOS</a> <span class=category-list-count>5</span></li><li class=category-list-item><a class=category-list-link href=/categories/NetWork/ >NetWork</a> <span class=category-list-count>2</span></li><li class=category-list-item><a class=category-list-link href=/categories/UX/ >UX</a> <span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=/categories/Windows/ >Windows</a> <span class=category-list-count>3</span></li></ul></div></div><div class=nexmoe-widget-wrap><div id=randomtagcloud class="nexmoe-widget tagcloud nexmoe-rainbow"><a href=/tags/APP/ style=font-size:12.86px>APP</a> <a href=/tags/AdGuard/ style=font-size:11.43px>AdGuard</a> <a href=/tags/Aria2/ style=font-size:10px>Aria2</a> <a href=/tags/CentOS/ style=font-size:12.86px>CentOS</a> <a href=/tags/Cloud/ style=font-size:10px>Cloud</a> <a href=/tags/DNS/ style=font-size:10px>DNS</a> <a href=/tags/Docker/ style=font-size:11.43px>Docker</a> <a href=/tags/Git/ style=font-size:11.43px>Git</a> <a href=/tags/HTML/ style=font-size:11.43px>HTML</a> <a href=/tags/Hackintosh/ style=font-size:11.43px>Hackintosh</a> <a href=/tags/Hexo/ style=font-size:11.43px>Hexo</a> <a href=/tags/IP/ style=font-size:11.43px>IP</a> <a href=/tags/Issue/ style=font-size:11.43px>Issue</a> <a href=/tags/JavaScript/ style=font-size:14.29px>JavaScript</a> <a href=/tags/JetBrains/ style=font-size:10px>JetBrains</a> <a href=/tags/Linux/ style=font-size:10px>Linux</a> <a href=/tags/MacOS/ style=font-size:10px>MacOS</a> <a href=/tags/MySQL/ style=font-size:11.43px>MySQL</a> <a href=/tags/NGINX/ style=font-size:10px>NGINX</a> <a href=/tags/NextCloud/ style=font-size:11.43px>NextCloud</a> <a href=/tags/Nodejs/ style=font-size:14.29px>Nodejs</a> <a href=/tags/PHP/ style=font-size:12.86px>PHP</a> <a href=/tags/SSH/ style=font-size:10px>SSH</a> <a href=/tags/Spider/ style=font-size:17.14px>Spider</a> <a href=/tags/Ubuntu/ style=font-size:11.43px>Ubuntu</a> <a href=/tags/npm/ style=font-size:11.43px>npm</a> <a href=/tags/Code/ style=font-size:12.86px>代码</a> <a href=/tags/FrontEnd/ style=font-size:11.43px>前端</a> <a href=/tags/Consult/ style=font-size:15.71px>咨询</a> <a href=/tags/Skill/ style=font-size:20px>技巧</a> <a href=/tags/Note/ style=font-size:18.57px>笔记</a> <a href=/tags/Terminal/ style=font-size:12.86px>终端</a> <a href=/tags/DSM/ style=font-size:10px>群晖</a> <a href=/tags/Sources/ style=font-size:10px>软件源</a></div><script>for(var maxTagcloud=parseInt(17),tags_length=parseInt(34),tags_arr=[],i=0;i<tags_length;i++)tags_arr.push(i);tags_arr.sort(function(a,t){return.5<Math.random()?-1:1});for(var tags_arr=tags_arr.slice(0,maxTagcloud<tags_length?tags_length-maxTagcloud:0),tag_i=0;tag_i<tags_arr.length;tag_i++)document.getElementById("randomtagcloud").children[tags_arr[tag_i]].style.display="none"</script></div><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>一言</h3><div class=nexmoe-widget><ul class=hitokoto-box><li id=hitokoto_text_parent class=hitokoto-text hitokotocategory=""><a href=# id=hitokoto_text></a> <a href=# id=hitokoto_error_text style=display:none></a></li></ul></div></div><script>let hitokotoText=document.getElementById("hitokoto_text"),hitokotoErroText=document.getElementById("hitokoto_error_text"),hitokotoCategory=document.getElementById("hitokoto_text_parent").getAttribute("hitokotoCategory");window.onload=function(){let t="https://v1.hitokoto.cn";hitokotoCategory&&(t+="?c="+hitokotoCategory),fetch(t).then(t=>t.json()).then(t=>{hitokotoText.innerText="「 "+t.hitokoto+" 」 from "+t.from,hitokotoText.href="https://hitokoto.cn/?uuid="+t.uuid}).catch(t=>{console.error(11,t),hitokotoText.style.display="none",hitokotoErroText.style.display="block"})}</script><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>文章归档</h3><div class=nexmoe-widget><ul class=archive-list><li class=archive-list-item><a class=archive-list-link href=/archives/2023/ >2023</a><span class=archive-list-count>7</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2022/ >2022</a><span class=archive-list-count>2</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2021/ >2021</a><span class=archive-list-count>18</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2020/ >2020</a><span class=archive-list-count>20</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2019/ >2019</a><span class=archive-list-count>1</span></li></ul></div></div><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>最新文章</h3><div class=nexmoe-widget><ul><li><a href=/article/powershell-perfect-setup/ >PowerShell 完美配置</a></li><li><a href=/article/hackintosh-one-key-hidip/ >黑苹果一键 HiDPI</a></li><li><a href=/article/say-no-to-meta-keywords/ >Meta Keywords：是什么、为什么不</a></li><li><a href=/article/dsm7-x-boot-compilation/ >黑群晖 DSM7.X 引导编译</a></li><li><a href=/article/lang-tag/ >HTML 设置 lang 属性的意义</a></li></ul></div></div></aside><div class=nexmoe-copyright>&copy; 2023 Shiux Powered by <a href=http://hexo.io/ target=_blank>Hexo</a> & <a href=https://github.com/theme-nexmoe/hexo-theme-nexmoe target=_blank>Nexmoe</a></div></div></div><div id=nexmoe-content><div class=nexmoe-primary><div class=nexmoe-post><article><div class="nexmoe-post-cover absolute" style=padding-top:NaN%><img src=https://s1.ax1x.com/2023/02/17/pSbzwGV.png alt="独特的 DNS 配置" loading=lazy><h1>独特的 DNS 配置</h1></div><div class=nexmoe-post-meta><div class=nexmoe-rainbow><a class="nexmoefont icon-calendar-fill">2020年02月23日</a> <a class="nexmoefont icon-appstore-fill -link" href=/categories/NetWork/ >NetWork</a> <a><i class="nexmoefont icon-areachart"></i>约6.2k字</a> <a><i class="nexmoefont icon-time-circle-fill"></i>预计需要24分钟</a></div></div><p>众所周知，DNS 的作用与电话簿类似，将人类可读的域名映射到机器可读 IP 地址、使人更方便地访问互联网。DNS 是非常重要的互联网基础设施，对于改善上网冲浪的体验中的重要程度不容小觑。</p><h2 id=避免不必要的DNS解析>避免不必要的 DNS 解析</h2><p>如果想要通过优化 DNS 来改善自己的网络体验，第一步其实是避免不必要的 DNS 解析。</p><h3 id=使用Fake-IP避免本机DNS解析>使用 Fake IP 避免本机 DNS 解析</h3><p>对于不支持设置 SOCKS/HTTP (S) 代理的软件，Surge/Clash 等软件一般选择通过 TUN/TAP 或转发 redir 透明网关接管网络请求，从而拿到原始的 TCP/IP 连接。</p><p>在 POSIX 规范下，执行网络请求需要先通过 gethostbyname、getremoteaddr 等操作系统提供的方法进行 DNS 解析，获取到 IP 地址以后发起连接；如果 DNS 解析不成功，网络请求就无从谈起了。因此绝大部分依赖 TUN 和 TAP 的某些软件都会接管系统 DNS 解析。接管 DNS 解析后随之而来的便是一系列问题：</p><ul><li>DNS 污染：由于特殊的网络环境，通过你本机直接进行 DNS 解析得到的结果可能不可靠。</li><li>CDN 优化：如果要访问的目标网站使用了 CDN，最理想的结果是 距离代理服务器最近的 CDN 节点 - 代理服务器 - 你。如果你通过本机直接进行 DNS 解析，获取到的 IP 地址可能并不是距离你远端代理服务器 最近的 CDN 节点。</li></ul><p>由于常见的某些协议都运行在 Layer 4 上、支持封装域名；因此 Surge/Clash 等软件在转发流量时，都是封装目标域名，而不是目标域名在本机解析到的 IP 地址，从而规避 DNS 污染和实现 CDN 优化。</p><p>如果软件一旦决定将某个域名转发给远端代理服务器，远端代理服务器也需要对拿到的域名进行一次解析，在本机解析的 IP 地址其实没有起任何作用，白白浪费一个 RTT。于是 2001 年四月，IETF 通过了 RFC3089，描述了一种网关通过接管 DNS、返回 Fake IP 来建立 TCP/IP 链接的方法。简单的流程如下：</p><ul><li>代理网关接管本机的 DNS 解析</li><li>一个软件意图对一个域名发起网络请求，于是先通过 DNS 解析获取域名对应的 IP</li><li>代理网关收到 DNS 解析请求后，不做任何 DNS 解析，而是直接返回一个保留 IP 地址（Fake IP）</li><li>发起网络请求的软件获取到 Fake IP 后，试图以 Fake IP 为目标发起网络请求</li><li>代理网关截获网络请求，通过目标的 Fake IP 反推出目标域名</li><li>代理网关将流量和目标域名使用某种协议重新封装后、转发给远端代理服务器</li></ul><p>不过在日常使用中，即使有了 Fake IP 也不能完全避免本机进行 DNS 解析。Surge/Clash 使用 Fake IP 后，当且只当以下两种情况时会在本机进行 DNS 解析：</p><ul><li>目标域名需要使用 DIRECT 策略（即直连）、此时 Surge/Clash 需要得到真实的目标 IP、不通过代理服务器直接发起连接</li><li>Surge/Clash 遇到了基于 IP 分流的策略（如 IP-CIDR、IP-ASN、GEOIP、LAN 等），此时 Surge/Clash 需要得到一个 IP 用于匹配分流</li></ul><p>也就是说，如果 Surge 和 Clash 能够匹配到了一条域名规则、指示网络请求需要被转发给远端代理服务器，Surge 和 Clash 便不会在本地进行 DNS 解析。因此在编写 Surge 和 Clash（以及同类软件 Shadowrocket、Quantumult (X)、Surfboard 等）的规则时，将 IP 相关规则（IP-CIDR、IP-ASN、GEOIP 等）放在其余的规则（DOMAIN、DST-PORT、SRC-PORT、PROTOCOL、URL-REGEX）的后面；除此以外，需要代理的域名的规则组越完善、Surge/Clash 匹配到 IP 类规则的概率也就越低，需要本机 DNS 解析的次数也就越少。</p><h3 id=使用域名分流规则直接拦截广告>使用域名分流规则直接拦截广告</h3><p>不论是去广告 Hosts 还是 AdGuardHome 等解决方案，本质上都是在 DNS 解析环节拦截域名；由于 DNS 的局限性，这类解决方案只能拦截完整的广告域名，不能拦截某一个域名下的具体 URL，因此要么不够强力、要么误杀严重，不能取代专业的浏览器去广告插件（如 ADBlock Plus、AdGuard for Chrome）和去广告软件（如 AdGuard for Android）。</p><p>除此以外，由于 Surge/Clash 等支持使用域名规则进行分流的软件也都提供了对 REJECT 策略的支持（Surge 还额外支持两种特殊的 REJECT 策略：不回复任何数据包、任由链接自行超时的 REJECT-DROP，和返回空白 1 像素 GIF 图像文件的 TINY-GIF）。因此，我们可以编写域名规则拦截广告请求、彻底杜绝被拦截域名的 DNS 解析、加快阻断。</p><blockquote><p>目前 Surge 支持 DOMAIN-SET 格式，可以在一个配置文件里记录数十万条域名，而不会内存泄漏或崩溃；Clash、Quantumult (X) 的域名规则可能不支持上万级别数量的域名、强行导入可能导致内存泄漏或 Panic；Surfboard 虽然完全兼容 Surge 的 DOMAIN-SET 格式，但是可能存在优化程度不够、达不到 Surge 同等速度和效率。<br>建议先对有关软件进行测试，如果不能很好的处理大量域名规则的，仍然可以使用 AdGuardHome 作为去广告的替代。</p></blockquote><h2 id=中场休息：递归DNS是怎么知道哪个CDN节点距离我最近的？>中场休息：递归 DNS 是怎么知道哪个 CDN 节点距离我最近的？</h2><p>先暂时抛开对我的 DNS 配置的介绍，简单谈谈递归 DNS（Local DNS）是如何实现「CDN 优化」的。</p><p>假设你的宽带 IP 是 <code>114.5.1.4</code>，你现在试图访问一个使用了阿里云 CDN 的网站 <code>alicdn.example.com</code>、接入 CDN 的方式是 CNAME 到 <code>alicdn.example.com.w.alikunlun.com</code>。</p><blockquote><p>注意，为了节省篇幅，在接下来的描述中，我刻意省去了 Local DNS 向 Root DNS 查询 <code>com</code> 和 <code>example.com</code> 的权威 DNS 的过程。如果想要了解完整的 DNS 查询过程，可以阅读由 Cloudflare 编写的 <a target=_blank rel=noopener href=https://www.cloudflare.com/learning/dns/what-is-dns/ >What is DNS? | How DNS works</a>。</p></blockquote><h3 id=运营商DNS>运营商 DNS</h3><p>一开始，你使用的是由运营商下发给你的运营商 DNS，假设运营商的递归 DNS 的 IP 是 <code>1.2.3.4</code>，于是：</p><ul><li>你向 <code>1.2.3.4</code> 发起 DNS 查询：请问 <code>alicdn.example.com</code> 的解析结果是什么？</li><li><code>1.2.3.4</code> 问 <code>example.com</code> 的权威 DNS 查询：<code>alicdn.example.com</code> 的解析结果是什么？</li><li><code>example.com</code> 的权威 DNS 告诉 <code>1.2.3.4</code>：<code>alicdn.example.com</code> 用 CNAME 指向了 <code>alicdn.example.com.w.alikunlun.com</code>。</li><li>于是 <code>1.2.3.4</code> 把结果返回给你：<code>alicdn.example.com</code> 用 CNAME 指向了 <code>alicdn.example.com.w.alikunlun.com</code></li><li>你问 <code>1.2.3.4</code>：请问 <code>alicdn.example.com.w.alikunlun.com</code> 的解析结果是什么？</li><li><code>1.2.3.4</code> 问 <code>alikunlun.com</code> 的权威 DNS：<code>alicdn.example.com.w.alikunlun.com</code> 的解析结果是什么？</li><li><code>alikunlun.com</code> 是阿里云 CDN 的域名，阿里的权威 DNS 开始找：地理位置最接近 <code>1.2.3.4</code> 的 CDN 节点是哪些？有 <code>19.19.8.10</code>。</li><li><code>alikunlun.com</code> 告诉 <code>1.2.3.4</code>：<code>alicdn.example.com.w.alikunlun.com</code> 解析到了 <code>19.19.8.10</code>。</li><li><code>1.2.3.4</code> 把结果返回给你：<code>alicdn.example.com.w.alikunlun.com</code> 解析到了 <code>19.19.8.10</code>。</li></ul><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2023/02/17/pSqQy9K.png alt=运营商DNS data-caption=运营商DNS loading=lazy></p><p>因此，阿里云 CDN 并不是返回「最适合你」的 CDN 节点 IP，而是返回「最适合这个运营商 DNS」的 CDN 节点 IP。只不过由于运营商 DNS 一般都距离你很近，所以也可以把这个结果当作是「最适合你」的 CDN 节点 IP。</p><h3 id=公共DNS>公共 DNS</h3><p>再后来，你听说南京信风提供的公共递归 DNS <code>114.114.114.114</code> 很有名，于是你手动将你的 DNS 设置为 <code>114.114.114.114</code>。</p><p><code>114.114.114.114</code> 是一个 Anycast IP，即一个 IP 能够对应不同区域、不同 ISP 的多个数据中心、多台服务器。截止到本文写就，南京信风仅在江苏南京的 电信、联通、移动 和 美国伊利诺伊州芝加哥的 Cogent 广播了 <code>114.114.114.114</code>，也就是说 <code>114.114.114.114</code> 仅对应到了这两地的服务器节点。一般的，国内的用户连接 <code>114.114.114.114</code>，都是访问位于江苏南京的节点。</p><p>你通过 <code>114.114.114.114</code> 和通过运营商 DNS 获取 <code>alicdn.example.com</code> 的解析结果的过程大同小异，区别在于这一次，<code>alikunlun.com</code> 并不会试图返回最适合 <code>1.2.3.4</code>（你的运营商 DNS）的 CDN 节点，而是试图返回最适合江苏南京的 CDN 节点。</p><p>由于中国复杂的互联网环境和封闭的网络基础设施建设，很难将 Anycast 覆盖到中国 30 余省市的十数个主流运营商、如上文所说，南京信风的 <code>114.114.114.114</code> 在国内甚至只有一个节点、只能覆盖三个运营商；即使是腾讯云 DNSPod 和阿里的公共 DNS，在国内也只有不到 10 个节点。</p><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2023/02/17/pSqQ61O.png alt=公用DNS data-caption=公用DNS loading=lazy></p><p>因此，在国内使用公共 DNS，不仅不能够优化 CDN，反而还会劣化 CDN。也是因为同一个原因，运营商要劫持你的 DNS 查询，避免因为你的 DNS 设置不当、反而投诉运营商的网络速度慢、差。</p><p>与此同时，公共 DNS 为了解决少数 Anycast 节点无法对应到全国 30 余省市数十个运营商的问题，另辟蹊径想出了一个新的方案：</p><h3 id=多出口IP的公共DNS>多出口 IP 的公共 DNS</h3><p>有的公共 DNS 除了在全国设立 Anycast 节点、负责接收 DNS 查询以外，还在全国 30 余省市均部署了额外的服务器（称作「DNS 出口服务器」）。这些 DNS 出口服务器不会直接接收来自终端用户的 DNS 查询，而是 Anycast 节点接收到终端用户的 DNS 查询后，转交给 DNS 出口服务器再进行解析：</p><ul><li>你（<code>114.5.1.4</code>）向 <code>233.5.5.5</code> 发起查询：请问 <code>alicdn.example.com</code> 的解析结果是什么？</li><li><code>223.5.5.5</code> 的众多 Anycast 节点中的一个收到了你的查询、开始寻找：我在全国部署的上百个 DNS 出口服务器中，哪一个是距离 <code>114.5.1.4</code> 最近的？</li><li>223.5.5.5 将 DNS 查询转交给距离你最近的 DNS 出口服务器（称作「DNS 出口 A」）。</li><li>DNS 出口 A 问 alikunlun.com 的权威 DNS：<code>alicdn.example.com.w.alikunlun.com</code> 的解析结果是什么？</li><li>阿里云 CDN 开始找：地理位置最接近 A 的 CDN 节点都是哪些？</li><li><code>alikunlun.com</code> 告诉 A：<code>alicdn.example.com.w.alikunlun.com</code> 解析到了这些 IP。</li><li>A 告诉 <code>223.5.5.5</code>：<code>alicdn.example.com.w.alikunlun.com</code> 解析到了这些 IP。</li><li><code>223.5.5.5</code> 告诉你：<code>alicdn.example.com.w.alikunlun.com</code> 解析到了这些 IP。</li></ul><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2023/02/17/pSqQfHA.png alt=多出口IP的公共DNS data-caption=多出口IP的公共DNS loading=lazy></p><p>这样，虽然接收到你查询的公共 DNS 的 Anycast 节点不一定距离你非常非常近，但是最终向权威 DNS 发起查询的，却是距离你尽可能近的「DNS 出口服务器」，因此得到的「最适合 DNS 出口服务器」的 CDN 节点 IP、也是最适合你的。</p><h3 id=支持EDNS-Client-Subnet的公共DNS>支持 EDNS Client Subnet 的公共 DNS</h3><p>为了解决权威 DNS 难以根据终端用户的真实 IP 返回最适合用户的 CDN 节点的问题，IETF 通过了 <a target=_blank rel=noopener href=https://datatracker.ietf.org/doc/html/rfc7871>RFC7871</a>，即 EDNS Client Subnet（ECS）。RFC7871 定义了在 DNS 查询时，用户可以指定一个 IP 网段，权威 DNS 可以据此返回最适合这个 IP 网段的 CDN 节点：</p><ul><li>你（<code>114.5.1.4</code>）问支持 ECS 的公共 DNS<code>119.29.29.29</code>：我是 <code>114.5.1.0/24</code>，请问 <code>alicdn.example.com.w.alikunlun.com</code> 的解析结果是什么？</li><li><code>119.29.29.29</code> 问 <code>alikunlun.com</code> 的权威 DNS：<code>114.5.1.0/24</code> 在问 <code>alicdn.example.com.w.alikunlun.com</code> 的解析结果是什么？</li><li>阿里云 CDN 开始找：地理位置最接近 <code>114.5.1.0/24</code> 的 CDN 节点都是哪些？</li><li><code>alikunlun.com</code> 告诉 <code>119.29.29.29</code>：<code>alicdn.example.com.w.alikunlun.com</code> 解析到了这些 IP。</li><li><code>119.29.29.29</code> 把结果返回给你：<code>alicdn.example.com.w.alikunlun.com</code> 解析到了这些 IP。</li></ul><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2023/02/17/pSqQHgS.png alt="支持EDNS Client Subnet的公共DNS" data-caption="支持EDNS Client Subnet的公共DNS" loading=lazy></p><p>虽然 ECS 解决了权威 DNS 无法获取用户真实 IP 的问题，但是在实践中仍然存在一些困难：</p><ul><li>使用 ECS 有可能泄漏用户的隐私信息，一些公共 DNS（如 Cloudflare 的 <code>1.1.1.1</code> 和 <code>1.0.0.1</code>）因此拒绝提供 ECS 支持。</li><li>在 <a target=_blank rel=noopener href=https://datatracker.ietf.org/doc/html/rfc7871#section-11.2>RFC7871 的 11.2 章节</a>中提到了一种针对 ECS 的攻击（即 Birthday Attack），因此当 DNS 请求 / 响应中的 ECS 信息不完整时、需要彻底忽略 ECS，降级回传统 DNS 查询。</li><li>使用 ECS 会降低递归 DNS 的性能、甚至可以被用于发动针对递归 DNS 的攻击：以前一个递归 DNS 可以为所有人缓存同一个 CDN 节点 IP，现在却需要为每个人缓存不同的 CDN 节点 IP。<a target=_blank rel=noopener href=https://datatracker.ietf.org/doc/html/rfc7871#section-11.3>RFC7871 的 11.3 章节</a>也因此指出，并非所有的递归 DNS 都需要支持 ECS。</li><li>ECS 需要从用户、到递归 DNS、到权威 DNS 全链路均提供支持才能生效。虽然在 <a target=_blank rel=noopener href=https://dnsflagday.net/ >DNSFlagDay</a> 的大力推动下，绝大部分权威 DNS 已经支持 ECS，但在递归 DNS 中 ECS 的普及率仍然不容乐观。</li></ul><hr><p>在补充介绍了递归 DNS 是如何优化 CDN 结果后，不难得出结论：</p><ul><li>需要被代理的域名、<strong>必须在远端代理服务器上进行解析</strong>、才能得到最合适的解析结果。</li><li>在本地对需要代理的域名进行 DNS 解析，只不过是为了让 Surge/Clash 等软件能够基于 IP 分流（Surge/Clash 的 TUN/TAP 会直接返回 Fake IP、本地 DNS 解析的结果根本不会暴露给外部）罢了。本地 DNS 解析的结果不需要很精确，<strong>建议牺牲准确度换更快的速度。</strong></li><li>为了能够让被代理的域名在远端服务器上解析，<strong>在通过某种协议将代理请求发送给远端代理服务器时，必须直接封装该网络请求的域名。</strong></li><li>使用 Surge/Clash 等软件后，<strong>完全无需使用 dnsproxy 或 dns2socks 转发本地 DNS 查询。代理此类 DNS 查询不仅没有必要，反而会导致延迟升高、影响上网体验。</strong></li></ul><h2 id=正确配置SmartDNS>正确配置 SmartDNS</h2><blockquote><p>SmartDNS 是一个运行在本地的 DNS 服务器，它接受来自本地客户端的 DNS 查询请求，然后从多个上游 DNS 服务器获取 DNS 查询结果，并将访问速度最快的结果返回给客户端，以此提高网络访问速度。SmartDNS 同时支持指定特定域名 IP 地址，能够以极高的性能进行匹配，可用于过滤广告或分流。</p></blockquote><p>由于 SmartDNS 的极致性能和强大特性，以及「提高网络访问速度」的功能，许多 YouTube 视频和教程文档都将其奉若神明、称为一切的解药。然而事实上，如果不经过仔细的配置，SmartDNS 不仅不能起到预期的效果，反而还会导致负优化。</p><p>如果一个网络请求将会被封装转发给远端代理服务器、会在远端代理服务器进行 DNS 解析，因此在本机进行的 DNS 解析得到的结果是没有任何意义的。因此，需要被代理的域名，并不在乎能否得到延时最低的 IP，<strong>只需要不干扰 Surge/Clash 等软件的 IP 分流规则即可，无需非常精确。</strong></p><blockquote><p>不需要对 SmartDNS 产生的 DNS 查询请求和测速握手进行代理。将 DNS 查询转发给远端代理服务器会大幅增加 DNS 解析用时、影响上网体验！</p></blockquote><p>因此，需要被代理的域名不需要进行测速 —— 测速不仅浪费一个 RTT，而且 ISP 和其它中间人可能会记录你的 ICMP 或 TCP 握手行为。除此以外，考虑到绝大部分递归 DNS（Local DNS）都可能存留日志用作各种用途（如下图所示的「中国科学技术大学 USTC 校园网 DNS 最近 10 分钟查询统计」），需要被代理的域名也最好不要选用位于国内的递归 DNS 作为上游。</p><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2023/02/17/pSqlCgU.png alt=最近10分钟查询统计 data-caption=最近10分钟查询统计 loading=lazy></p><h3 id=中场休息：SmartDNS是如何避免因测速导致DNS解析过慢的>中场休息：SmartDNS 是如何避免因测速导致 DNS 解析过慢的</h3><p>第二个中场休息环节，这次简单讲讲 SmartDNS 的工作原理。</p><p>有一些人认为，SmartDNS 配置了数十个上游，需要对上游返回的每一个 IP 都进行测速，反而严重影响 DNS 解析速度。但是实际使用 SmartDNS 后，并没有出现 DNS 解析过慢的情况。这是因为 SmartDNS 早就考虑到了测速与延时的问题、并进行了相关的优化。SmartDNS 在首次 DNS 解析请求时，会同时向所有上游发起并发查询；一旦有一个上游返回了结果，SmartDNS 就会对这第一个返回的结果进行测速，得到其中延时最低的 IP，将其返回给用户、设置 TTL 为 10；与此同时，SmartDNS 仍然会等待剩余上游返回结果、异步进行测速，直到所有上游都返回了结果（或超时）、SmartDNS 将所有的 IP 都进行测速以后，才会得到最优 IP：</p><ul><li>假设我们向 SmartDNS 解析一个域名 <code>example.com</code>，由于没有命中 SmartDNS 的缓存，因此不得不向上游获取结果。</li><li>SmartDNS 同时向上游 A、B、C 发起查询请求</li><li>假设上游 B 最先返回了查询结果，查询结果包含了三个 IP：<code>114.5.1.4</code>、<code>11.45.1.4</code> 和 <code>19.19.8.10</code>。</li><li>SmartDNS 立刻开始对这三个 IP 进行测速。假设测得延时最低的 IP 是 <code>11.45.1.4</code></li><li>SmartDNS 会立刻返回 <code>11.45.1.4</code> 给客户端，同时设置 TTL 为 10（即指示 <code>11.45.1.4</code> 只应该在客户端被缓存 10 秒中）</li><li>在接下来 10 秒内，客户端都会使用都会使用 <code>11.45.1.4</code> 来处理发往 <code>example.com</code> 的网络连接；与此同时 SmartDNS 仍然在等待上游 A 和 C 的结果。</li><li>一旦上游 A 和 C 的查询结果也都返回，SmartDNS 会把上游 A、B、C 的结果进行汇总去重、重新测速，最终得到最快的那个 IP。</li><li>由于 SmartDNS 有着非常严格的超时设置，因此上述「等待剩余上游结果并分别进行测速」步骤不会超过 10 秒。</li><li>等到 10 秒过去、客户端再次向 SmartDNS 查询 <code>example.com</code> 时，SmartDNS 才会返回最快的 IP、并设置一个「正确」的 TTL。</li></ul><p>总而言之，SmartDNS 首先会尽快返回一个「次优」的 IP、要求客户端仅在接下来 10 秒钟内使用「次优」的 IP，之后 SmartDNS 就能返回「最优」的 IP。</p><blockquote><p>不过正如我在前文所说，Surge 支持针对 DNS 返回的多个 IP 同时进行握手、并使用最先完成握手的 TCP 进行后续请求（丢弃其余的 TCP 握手），因此 Surge 使用的 IP 一定是延时最低的、而且能够跳过出现故障的 IP；而且 Surge 复用了并发握手时的 TCP 连接进行后续请求，因此延时比 SmartDNS「先测速、后返回 IP」更低。<br>因此在搭配 Surge 使用时，上游 DNS 不需要自带测速；最好是能合并多个上游返回的结果，将多个上游返回的一大堆 IP 全部喂给 Surge、让其并发握手。我给 SmartDNS 开了<a target=_blank rel=noopener href=https://github.com/pymumu/smartdns/issues/994>对应的 Feature Request</a>，感兴趣的可以关注一下。</p></blockquote><h3 id=在SmartDNS中使用dnsmasq-china-list进行分流>在 SmartDNS 中使用 dnsmasq-china-list 进行分流</h3><p><a target=_blank rel=noopener href=https://github.com/felixonmars/dnsmasq-china-list>felixonmars/dnsmasq-china-list</a> 是一组开源的，覆盖了绝大部分中国大陆的域名的 dnsmasq 配置文件，也可以通过预定义的 <code>Makefile</code> 生成供 unbound、bind9、dnscrypt-proxy、SmartDNS、AdGuardHome、coredns 使用的配置文件。截至本文写就，<code>dnsmasq-china-list</code> 已经收录了 65743 个域名。满足以下任意两条规则之一的域名即会被收录到列表中：</p><ul><li>是<code>.cn</code> 后缀的域名（包括<code>.edu.cn</code>、<code>.gov.cn</code>、<code>.org.cn</code>、<code>.ac.cn</code> 等）</li><li>满足以下两条规则中任意一条的、非<code>.cn</code> 后缀的域名：<ul><li>域名使用的权威 DNS（Authoritative DNS）拥有位于中国大陆境内的节点</li><li>通过位于中国大陆境内的递归 DNS 解析时，解析得到的 IP 位于中国大陆境内</li></ul></li></ul><p>如果需要设置 SmartDNS 针对指定域名使用与默认配置不同的上游进行解析，可以使用 nameserver，如下所示：</p><figure class="highlight properties"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs properties"><span class=hljs-attr>nameserver</span> <span class=hljs-string>/example.cn/domestic</span><br></code></pre></td></tr></tbody></table></figure><p>如果需要设置 SmartDNS 针对指定域名不使用默认配置的上游、且采用与默认不同的测速方式，需要使用 <code>domain-rules</code>，如下所示：</p><figure class="highlight properties"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs properties"><span class=hljs-attr>domain-rules</span> <span class=hljs-string>/example.cn/ -speed-check-mode tcp:80 -nameserver domestic</span><br></code></pre></td></tr></tbody></table></figure><p><code>dnsmasq-china-list</code> 预定义的 <code>Makefile</code> 同时支持生成上述两种配置格式的文件。使用下述命令可以生成使用 <code>nameserver</code> 的配置条目：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">make SERVER=domestic smartdns<br></code></pre></td></tr></tbody></table></figure><p>我给 <code>dnsmasq-china-list</code> 开了 PR（<a target=_blank rel=noopener href=https://github.com/felixonmars/dnsmasq-china-list/pull/381>felixonmars/dnsmasq-china-list#381</a>）且已经被合并，现在已经可以生成使用 <code>domain-rules</code> 的配置条目：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">make SERVER=domestic SMARTDNS_SPEEDTEST_MODE=tcp:80 smartdns-domain-rules<br></code></pre></td></tr></tbody></table></figure><blockquote><p>注意，你可能需要安装 <code>make</code> 才可以使用上述命令。在 macOS 上，<code>make</code> 包含在 Xcode Command Line Tools 之中。</p></blockquote><h3 id=配置-SmartDNS-上游和仅测速国内域名>配置 SmartDNS 上游和仅测速国内域名</h3><p>如前文所说，在本地解析需要被代理的域名时，不需要测速、也不一定要绝对准确，只需要解析得到的 IP 不会干扰 Surge/Clash 分流即可；只将国内的递归 DNS 作为上游解析国内直连域名，也只对其进行测速。因此，我们使用「白名单」策略，默认解析不测速、不使用国内递归 DNS 作为上游。</p><p>首先需要禁用 SmartDNS 全局的测速设置：</p><figure class="highlight properties"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs properties"><span class=hljs-attr>speed-check-mode</span> <span class=hljs-string>none</span><br></code></pre></td></tr></tbody></table></figure><p>然后设置两组上游 DNS：默认的一组不位于中国大陆境内的递归 DNS；另一组位于中国大陆境内的递归 DNS，仅用于解析 <code>dnsmasq-china-list</code> 列表中的域名：</p><figure class="highlight properties"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre></td><td class=code><pre><code class="hljs properties"><span class=hljs-comment># ----- Default Group -----</span><br><span class=hljs-comment># 默认使用的上游 DNS 组</span><br><span class=hljs-comment># OpenDNS 非常规 443 端口、支持 TCP 查询</span><br><span class=hljs-attr>server-tcp</span> <span class=hljs-string>208.67.220.220:443</span><br><span class=hljs-comment># OpenDNS 的 IP DoH</span><br><span class=hljs-attr>server-https</span> <span class=hljs-string>https://146.112.41.2/dns-query</span><br><span class=hljs-comment># TWNIC 的 IP DoH</span><br><span class=hljs-attr>server-https</span> <span class=hljs-string>https://101.101.101.101/dns-query</span><br><span class=hljs-comment># 你也可以配置其它 DNS 作为上游</span><br><span class=hljs-comment></span><br><span class=hljs-comment># ----- Domestic Group: domestic -----</span><br><span class=hljs-comment># 仅用于解析 dnsmasq-china-list 列表中的域名</span><br><span class=hljs-comment># 腾讯 DNSPod IP DoT</span><br><span class=hljs-attr>server-tls</span> <span class=hljs-string>1.12.12.12:853 -group domestic -exclude-default-group</span><br><span class=hljs-attr>server-tls</span> <span class=hljs-string>120.53.53.53:853 -group domestic -exclude-default-group</span><br><span class=hljs-comment># 阿里 IP DoT</span><br><span class=hljs-attr>server-tls</span> <span class=hljs-string>223.5.5.5:853 -group domestic -exclude-default-group</span><br><span class=hljs-attr>server-tls</span> <span class=hljs-string>223.6.6.6:853 -group domestic -exclude-default-group</span><br><span class=hljs-comment># 114 DNS、使用 TCP 查询</span><br><span class=hljs-attr>server-tcp</span> <span class=hljs-string>114.114.114.114 -group domestic -exclude-default-group</span><br><span class=hljs-attr>server-tcp</span> <span class=hljs-string>114.114.115.115 -group domestic -exclude-default-group</span><br><span class=hljs-comment># CNNIC 公共 DNS、仅支持 UDP 查询</span><br><span class=hljs-attr>server</span> <span class=hljs-string>1.2.4.8 -group domestic -exclude-default-group</span><br><span class=hljs-attr>server</span> <span class=hljs-string>210.2.4.8 -group domestic -exclude-default-group</span><br></code></pre></td></tr></tbody></table></figure><p>其中，设置有 <code>-exclude-default-group</code> 的上游 DNS 默认不会被使用，仅当 <code>domain-rules</code> 或 <code>nameserver</code> 配置明确指定时使用。</p><blockquote><p>你可能注意到，我的配置中添加了 CNNIC（中国互联网络信息中心）的公共 DNS。这是考虑到 CNNIC 的公共 DNS 节点质量较差、出口 IP 位置稀少、基本没有针对 CDN 做任何优化（截至本文写就，<code>1.2.4.8</code> 的 Anycast 仅在浙江杭州阿里云和香港 Zenlayer 广播路由，<code>210.2.4.8</code> 的 Anycast 仅在 北京联通广播路由）。所以，一般情况下，只有 CNNIC 的公共 DNS <strong>一定不能</strong>返回距离我位置最近的 CDN 节点（其余的公共 DNS 基本都会返回给我最优的 CDN 节点）。<br>设想一下，除 CNNIC 外、大部分公共 DNS 都会尽可能返回距离我本地运营商最近的、最优的 CDN 节点；由于 SmartDNS 的测速和优选，CNNIC 返回的非最优 CDN 节点一般会被忽略。然而，假如距离我最近的 CDN 节点出现故障，只有 CNNIC 能够给我返回不一样的 CDN 节点、能够响应 SmartDNS 测速，因此我能够使用并非最优、但是可用的 CDN 节点「救急」、不至于直接「断网」。<br>简单来说，就是因为 CNNIC 公共 DNS <strong>能够非常稳定地提供质量最差的递归 DNS 服务、不会间歇发生解析质量好转</strong>，才得以入选。</p></blockquote><p>最后，引入前文由 <code>dnsmasq-china-list</code> 生成的 <code>domain-rules</code> 配置文件：</p><figure class="highlight properties"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs properties"><span class=hljs-attr>conf-file</span> <span class=hljs-string>/path/to/dnsmasq-china-list/accelerated-domains.china.domain.smartdns.conf</span><br><span class=hljs-attr>conf-file</span> <span class=hljs-string>/path/to/dnsmasq-china-list/apple.china.domain.smartdns.conf</span><br></code></pre></td></tr></tbody></table></figure></article><div class="nexmoe-post-meta nexmoe-rainbow"><a class="nexmoefont icon-tag-fill -none-link" href=/tags/DNS/ rel=tag>DNS</a> <a class="nexmoefont icon-tag-fill -none-link" href=/tags/IP/ rel=tag>IP</a> <a class="nexmoefont icon-tag-fill -none-link" href=/tags/MacOS/ rel=tag>MacOS</a> <a class="nexmoefont icon-tag-fill -none-link" href=/tags/Skill/ rel=tag>技巧</a></div><div class=nexmoe-post-footer><script src=https://giscus.app/client.js data-repo=fungyua/blog-comments data-repo-id="MDEwOlJlcG9zaXRvcnk0MDQ0NTY2OTQ=" data-category=Comments data-category-id=DIC_kwDOGBuE9s4CTUfb data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></div></div><div class=nexmoe-post-right><div class=nexmoe-fixed><div class=nexmoe-tool><button class="mdui-fab catalog" style=overflow:unset><i class="nexmoefont icon-i-catalog"></i><div class=nexmoe-toc><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E9%81%BF%E5%85%8D%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84DNS%E8%A7%A3%E6%9E%90><span class=toc-number>1.</span> <span class=toc-text>避免不必要的 DNS 解析</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BD%BF%E7%94%A8Fake-IP%E9%81%BF%E5%85%8D%E6%9C%AC%E6%9C%BADNS%E8%A7%A3%E6%9E%90><span class=toc-number>1.1.</span> <span class=toc-text>使用 Fake IP 避免本机 DNS 解析</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BD%BF%E7%94%A8%E5%9F%9F%E5%90%8D%E5%88%86%E6%B5%81%E8%A7%84%E5%88%99%E7%9B%B4%E6%8E%A5%E6%8B%A6%E6%88%AA%E5%B9%BF%E5%91%8A><span class=toc-number>1.2.</span> <span class=toc-text>使用域名分流规则直接拦截广告</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B8%AD%E5%9C%BA%E4%BC%91%E6%81%AF%EF%BC%9A%E9%80%92%E5%BD%92DNS%E6%98%AF%E6%80%8E%E4%B9%88%E7%9F%A5%E9%81%93%E5%93%AA%E4%B8%AACDN%E8%8A%82%E7%82%B9%E8%B7%9D%E7%A6%BB%E6%88%91%E6%9C%80%E8%BF%91%E7%9A%84%EF%BC%9F><span class=toc-number>2.</span> <span class=toc-text>中场休息：递归 DNS 是怎么知道哪个 CDN 节点距离我最近的？</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%BF%90%E8%90%A5%E5%95%86DNS><span class=toc-number>2.1.</span> <span class=toc-text>运营商 DNS</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%85%AC%E5%85%B1DNS><span class=toc-number>2.2.</span> <span class=toc-text>公共 DNS</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%A4%9A%E5%87%BA%E5%8F%A3IP%E7%9A%84%E5%85%AC%E5%85%B1DNS><span class=toc-number>2.3.</span> <span class=toc-text>多出口 IP 的公共 DNS</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%94%AF%E6%8C%81EDNS-Client-Subnet%E7%9A%84%E5%85%AC%E5%85%B1DNS><span class=toc-number>2.4.</span> <span class=toc-text>支持 EDNS Client Subnet 的公共 DNS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%AD%A3%E7%A1%AE%E9%85%8D%E7%BD%AESmartDNS><span class=toc-number>3.</span> <span class=toc-text>正确配置 SmartDNS</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%B8%AD%E5%9C%BA%E4%BC%91%E6%81%AF%EF%BC%9ASmartDNS%E6%98%AF%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%9B%A0%E6%B5%8B%E9%80%9F%E5%AF%BC%E8%87%B4DNS%E8%A7%A3%E6%9E%90%E8%BF%87%E6%85%A2%E7%9A%84><span class=toc-number>3.1.</span> <span class=toc-text>中场休息：SmartDNS 是如何避免因测速导致 DNS 解析过慢的</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%9C%A8SmartDNS%E4%B8%AD%E4%BD%BF%E7%94%A8dnsmasq-china-list%E8%BF%9B%E8%A1%8C%E5%88%86%E6%B5%81><span class=toc-number>3.2.</span> <span class=toc-text>在 SmartDNS 中使用 dnsmasq-china-list 进行分流</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E9%85%8D%E7%BD%AE-SmartDNS-%E4%B8%8A%E6%B8%B8%E5%92%8C%E4%BB%85%E6%B5%8B%E9%80%9F%E5%9B%BD%E5%86%85%E5%9F%9F%E5%90%8D><span class=toc-number>3.3.</span> <span class=toc-text>配置 SmartDNS 上游和仅测速国内域名</span></a></li></ol></li></ol></div></button> <a href=#nexmoe-content class=toc-link aria-label="Back To Top" title=top><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a></div></div></div></div></div><div id=nexmoe-search-space><div class=search-container><div class=search-header><div class=search-input-container><input class=search-input type=text placeholder=搜索 oninput=sinput()></div><a class=search-close onclick=sclose()>×</a></div><div class=search-body></div></div></div><script src=/lib/mdui_043tiny/mdui.js></script><script src=/lib/fancybox/fancybox.umd.js></script><script async src="/js/app.js?v=1677079625820"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2058306854838448" crossorigin=anonymous></script></body></html>