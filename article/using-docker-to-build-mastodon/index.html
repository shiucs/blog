<!DOCTYPE html><html lang=zh-CN><head><title>使用 Docker 搭建 Mastodon - ShiuxのBlog</title><meta charset=UTF-8><meta name=keywords content=""><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><link rel="shortcut icon" href=/logo.svg type=image/x-icon><meta name=description content="为什么开始使用 Docker 搭建实例 开始使用 Docker 纯属一个手残意外导致的阴差阳错：我不小心在升级时按了 DigitalOcean 面板里的 “关闭服务器” 按钮，相当于跑着程序突然拔了主机电源，导致整个服务器出现大型罢工。最后由兔子帮（代）助（劳）我迁移了站点，方便起见部署在了 Docker 上。于是在此也提醒各位，想要关闭 Mastodon 服务，一定要使用 systemctl s"><meta property=og:type content=article><meta property=og:title content="使用 Docker 搭建 Mastodon"><meta property=og:url content=https://blog.shiux.com/article/using-docker-to-build-mastodon/index.html><meta property=og:site_name content=ShiuxのBlog><meta property=og:description content="为什么开始使用 Docker 搭建实例 开始使用 Docker 纯属一个手残意外导致的阴差阳错：我不小心在升级时按了 DigitalOcean 面板里的 “关闭服务器” 按钮，相当于跑着程序突然拔了主机电源，导致整个服务器出现大型罢工。最后由兔子帮（代）助（劳）我迁移了站点，方便起见部署在了 Docker 上。于是在此也提醒各位，想要关闭 Mastodon 服务，一定要使用 systemctl s"><meta property=og:locale content=zh_CN><meta property=og:image content=https://s1.ax1x.com/2020/07/22/U7oZrR.png><meta property=og:image content=https://s1.ax1x.com/2020/07/22/U7TYpF.png><meta property=og:image content=https://s1.ax1x.com/2020/07/22/U7T79S.png><meta property=og:image content=https://s1.ax1x.com/2020/07/23/UXkujS.png><meta property=article:published_time content=2021-08-28T11:50:13.000Z><meta property=article:modified_time content=2023-06-30T02:35:39.001Z><meta property=article:author content=Shiux><meta property=article:tag content=Docker><meta name=twitter:card content=summary><meta name=twitter:image content=https://s1.ax1x.com/2020/07/22/U7oZrR.png><link rel=stylesheet href=/lib/fancybox/fancybox.css><link rel=stylesheet href=/lib/mdui_043tiny/mdui.css><link rel=stylesheet href="/lib/iconfont/iconfont.css?v=1688092602354"><link rel=stylesheet href="/css/style.css?v=1688092602354"><link rel=stylesheet href="/custom.css?v=1688092602354"><script src=/lib/mdui_043tiny/mdui.js async></script><script src=/lib/fancybox/fancybox.umd.js async></script><script async src="/js/app.js?v=1688092602354"></script><meta name=generator content="Hexo 6.3.0"></head><body class=mdui-drawer-body-left><div id=nexmoe-background><div class=nexmoe-bg style="background-image:url(https://api.btstu.cn/sjbz/api.php?lx=dongman&format=images)"></div><div class="mdui-appbar mdui-shadow-0"><div class=mdui-toolbar><a mdui-drawer="{target: '#drawer', swipe: true}" title=menu class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a><div class=mdui-toolbar-spacer></div><a href=/ title=Shiux class="mdui-btn mdui-btn-icon"><img src=/logo.svg alt=Shiux></a></div></div></div><div id=nexmoe-header><div class="nexmoe-drawer mdui-drawer" id=drawer><div class="nexmoe-avatar mdui-ripple"><a href=/ title=Shiux><img src=/logo.svg alt=Shiux alt=Shiux></a></div><div class=nexmoe-count><div><span>文章</span>50</div><div><span>标签</span>38</div><div><span>分类</span>7</div></div><div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}"><a class="nexmoe-list-item mdui-list-item mdui-ripple false" href=/ title=回到首页><i class="mdui-list-item-icon nexmoefont icon-home"></i><div class=mdui-list-item-content>回到首页</div></a><a class="nexmoe-list-item mdui-list-item mdui-ripple false" href=/archive.html title=文章归档><i class="mdui-list-item-icon nexmoefont icon-container"></i><div class=mdui-list-item-content>文章归档</div></a><a class="nexmoe-list-item mdui-list-item mdui-ripple false" href=/about.html title=关于博主><i class="mdui-list-item-icon nexmoefont icon-info-circle"></i><div class=mdui-list-item-content>关于博主</div></a></div><aside id=nexmoe-sidebar><div class=nexmoe-widget-wrap><div class="nexmoe-widget nexmoe-social"><a class=mdui-ripple href=https://github.com/shiucs/ target=_blank mdui-tooltip="{content: 'GitHub'}" style=color:#191717;background-color:rgba(25,23,23,.1)><i class="nexmoefont icon-github"></i> </a><a class=mdui-ripple href=https://www.zhihu.com/people/fungyua target=_blank mdui-tooltip="{content: '知乎'}" style=color:#1e88e5;background-color:rgba(30,136,229,.1)><i class="nexmoefont icon-zhihu"></i></a></div></div><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>文章分类</h3><div class=nexmoe-widget><ul class=category-list><li class=category-list-item><a class=category-list-link href=/categories/Code/ >Code</a> <span class=category-list-count>21</span></li><li class=category-list-item><a class=category-list-link href=/categories/Guide/ >Guide</a> <span class=category-list-count>12</span></li><li class=category-list-item><a class=category-list-link href=/categories/Linux/ >Linux</a> <span class=category-list-count>5</span></li><li class=category-list-item><a class=category-list-link href=/categories/MacOS/ >MacOS</a> <span class=category-list-count>5</span></li><li class=category-list-item><a class=category-list-link href=/categories/NetWork/ >NetWork</a> <span class=category-list-count>2</span></li><li class=category-list-item><a class=category-list-link href=/categories/UX/ >UX</a> <span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=/categories/Windows/ >Windows</a> <span class=category-list-count>4</span></li></ul></div></div><div class=nexmoe-widget-wrap><div id=randomtagcloud class="nexmoe-widget tagcloud nexmoe-rainbow"><a href=/tags/APP/ style=font-size:12.86px>APP</a> <a href=/tags/AdGuard/ style=font-size:11.43px>AdGuard</a> <a href=/tags/Aria2/ style=font-size:10px>Aria2</a> <a href=/tags/CentOS/ style=font-size:12.86px>CentOS</a> <a href=/tags/Cloud/ style=font-size:10px>Cloud</a> <a href=/tags/DNS/ style=font-size:10px>DNS</a> <a href=/tags/Docker/ style=font-size:11.43px>Docker</a> <a href=/tags/FastAPI/ style=font-size:10px>FastAPI</a> <a href=/tags/Git/ style=font-size:11.43px>Git</a> <a href=/tags/HTML/ style=font-size:11.43px>HTML</a> <a href=/tags/Hackintosh/ style=font-size:11.43px>Hackintosh</a> <a href=/tags/Hexo/ style=font-size:11.43px>Hexo</a> <a href=/tags/IP/ style=font-size:11.43px>IP</a> <a href=/tags/Issue/ style=font-size:11.43px>Issue</a> <a href=/tags/JavaScript/ style=font-size:14.29px>JavaScript</a> <a href=/tags/JetBrains/ style=font-size:10px>JetBrains</a> <a href=/tags/Linux/ style=font-size:10px>Linux</a> <a href=/tags/MacOS/ style=font-size:10px>MacOS</a> <a href=/tags/MySQL/ style=font-size:11.43px>MySQL</a> <a href=/tags/NGINX/ style=font-size:10px>NGINX</a> <a href=/tags/NextCloud/ style=font-size:11.43px>NextCloud</a> <a href=/tags/Nodejs/ style=font-size:14.29px>Nodejs</a> <a href=/tags/PHP/ style=font-size:12.86px>PHP</a> <a href=/tags/PIP/ style=font-size:10px>PIP</a> <a href=/tags/Powershell/ style=font-size:10px>Powershell</a> <a href=/tags/SQLAlchemy/ style=font-size:10px>SQLAlchemy</a> <a href=/tags/SSH/ style=font-size:10px>SSH</a> <a href=/tags/Spider/ style=font-size:17.14px>Spider</a> <a href=/tags/Ubuntu/ style=font-size:11.43px>Ubuntu</a> <a href=/tags/npm/ style=font-size:11.43px>npm</a> <a href=/tags/Code/ style=font-size:12.86px>代码</a> <a href=/tags/FrontEnd/ style=font-size:11.43px>前端</a> <a href=/tags/Consult/ style=font-size:15.71px>咨询</a> <a href=/tags/Skill/ style=font-size:20px>技巧</a> <a href=/tags/Note/ style=font-size:18.57px>笔记</a> <a href=/tags/Terminal/ style=font-size:14.29px>终端</a> <a href=/tags/DSM/ style=font-size:10px>群晖</a> <a href=/tags/Sources/ style=font-size:10px>软件源</a></div><script>for(var maxTagcloud=parseInt(17),tags_length=parseInt(38),tags_arr=[],i=0;i<tags_length;i++)tags_arr.push(i);tags_arr.sort(function(a,t){return.5<Math.random()?-1:1});for(var tags_arr=tags_arr.slice(0,maxTagcloud<tags_length?tags_length-maxTagcloud:0),tag_i=0;tag_i<tags_arr.length;tag_i++)document.getElementById("randomtagcloud").children[tags_arr[tag_i]].style.display="none"</script></div><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>一言</h3><div class=nexmoe-widget><ul class=hitokoto-box><li id=hitokoto_text_parent class=hitokoto-text hitokotocategory=""><a href=# id=hitokoto_text></a> <a href=# id=hitokoto_error_text style=display:none></a></li></ul></div></div><script>let hitokotoText=document.getElementById("hitokoto_text"),hitokotoErroText=document.getElementById("hitokoto_error_text"),hitokotoCategory=document.getElementById("hitokoto_text_parent").getAttribute("hitokotoCategory");window.addEventListener("load",function(){let t="https://v1.hitokoto.cn";hitokotoCategory&&(t+="?c="+hitokotoCategory),fetch(t).then(t=>t.json()).then(t=>{hitokotoText.innerText="「 "+t.hitokoto+" 」 from "+t.from,hitokotoText.href="https://hitokoto.cn/?uuid="+t.uuid}).catch(t=>{console.error(11,t),hitokotoText.style.display="none",hitokotoErroText.style.display="block"})})</script><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>文章归档</h3><div class=nexmoe-widget><ul class=archive-list><li class=archive-list-item><a class=archive-list-link href=/archives/2023/ >2023</a><span class=archive-list-count>9</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2022/ >2022</a><span class=archive-list-count>2</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2021/ >2021</a><span class=archive-list-count>18</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2020/ >2020</a><span class=archive-list-count>20</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2019/ >2019</a><span class=archive-list-count>1</span></li></ul></div></div><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>最新文章</h3><div class=nexmoe-widget><ul><li><a href=/article/python-pip-issue/ >修改了 Python 安装目录的文件夹名称而无法使用 pip 的两种实用解决方法</a></li><li><a href=/article/python-fastapi-sqlalchemy/ >Python FastAPI 框架配合 SQLAlchemy 操作 Mysql 数据库 增删改查</a></li><li><a href=/article/powershell-perfect-setup/ >Powershell 完美配置</a></li><li><a href=/article/hackintosh-one-key-hidip/ >黑苹果一键 HiDPI</a></li><li><a href=/article/say-no-to-meta-keywords/ >Meta Keywords：是什么、为什么不</a></li></ul></div></div></aside><div class=nexmoe-copyright>&copy; 2023 Shiux Powered by <a href=http://hexo.io/ target=_blank>Hexo</a> & <a href=https://github.com/theme-nexmoe/hexo-theme-nexmoe target=_blank>Nexmoe</a></div></div></div><div id=nexmoe-content><div class=nexmoe-primary><div class=nexmoe-post><article><div class=nexmoe-post-cover><img src="https://api.btstu.cn/sjbz/api.php?lx=dongman&format=images" alt="使用 Docker 搭建 Mastodon" loading=lazy><h1>使用 Docker 搭建 Mastodon</h1></div><div class=nexmoe-post-meta><div class=nexmoe-rainbow><a class="nexmoefont icon-calendar-fill">2021年08月28日</a> <a class="nexmoefont icon-appstore-fill -link" href=/categories/Code/ >Code</a> <a><i class="nexmoefont icon-areachart"></i>约4.7k字</a> <a><i class="nexmoefont icon-time-circle-fill"></i>预计需要19分钟</a></div></div><h2 id=为什么开始使用Docker搭建实例>为什么开始使用 Docker 搭建实例</h2><p>开始使用 Docker 纯属一个手残意外导致的阴差阳错：我不小心在升级时按了 DigitalOcean 面板里的 “关闭服务器” 按钮，相当于跑着程序突然拔了主机电源，导致整个服务器出现大型罢工。最后由兔子帮（代）助（劳）我迁移了站点，方便起见部署在了 Docker 上。于是在此也提醒各位，想要关闭 Mastodon 服务，一定要使用 <code>systemctl stop 具体服务（mastodon-sidekiq、mastodon-web以及mastodon-streaming）</code>的方法，千万不要硬关。</p><p>在使用了一段时间的 Docker 之后，我总结出以下 Docker 搭建的优缺点：</p><h3 id=优点>优点</h3><ol><li>搭建、升级方便，命令简单，不用自行配置环境，比起用官方文档命令行搭建而言，更适合新手。</li><li>对内存较小的服务器，可以免除每次升级需要的编译（precompile）步骤给小机器带来的负担。</li><li>Mastodon 站点运行在一个隔离的小环境（容器）中，安全性较高，不怕新手操作把整个系统搞崩，出现问题之后只要重启即可，会按镜像自动复原。</li></ol><h3 id=缺点>缺点</h3><ol><li>可用教程较少，许多命令需要重新学起。</li><li>魔改字数等相对而言不太方便，需要增加一个步骤，在之后的博文会详细列出。</li><li>需要学习 docker 相关命令。</li></ol><p>总体而言，对于一个新手，docker 维护起来相对还是比较方便（皮实耐操）的。大家可以自行决定。但搜索互联网，官方并没有给出 docker 的搭建指南，而民间指南要么过时、要么有冗余步骤会占用大量时间。因此，希望这篇教程能给大家带来一些帮助。</p><h2 id=如何在Docker上从头搭建Mastodon>如何在 Docker 上从头搭建 Mastodon</h2><h3 id=购买域名、购买服务器、配置SMTP服务>购买域名、购买服务器、配置 SMTP 服务</h3><p>这三步为建站基础，请大家参考本站<a target=_blank rel=noopener href=https://pullopen.github.io/%E5%9F%BA%E7%A1%80%E6%90%AD%E5%BB%BA/2020/07/19/How-to-build-a-mastodon-instance.html>最早教程</a>的前 3 步逐一完成。</p><p>其中，服务器可在任何一家服务器提供商购买，不必局限于（也不推荐）DigitalOcean。其他如国人常用的 Vultur、Digital Ocean，或者位于德国的 Contabo、Hetzner 等都可以。你可以参考<a target=_blank rel=noopener href=https://www.zhujiceping.com/ >主机测评网站</a>蹲服务器折扣。此外，<a target=_blank rel=noopener href=https://www.notion.so/68b0e4bb0b9e4fa5a9dd74d03b71a328>O3O 站长搭站指南</a>有更详细的指导意见。</p><p>购买时选择操作系统为 <strong>Ubuntu 或 Debian</strong> 即可。本文教程均以此系统为准。</p><p>无论你选择哪家服务器，请都<strong>不要使用位于国内的服务器</strong>，最好<strong>不要选择国内的服务器提供商</strong>，否则你可能会面临无法与其他站点互联互通、甚至站点下线的风险。</p><p>Mastodon 系统较为庞大，如果运行一个单人实例，请保证内存至少在 1G 以上，储存至少在 25G 以上。如果预计用户数量增加，请相应增加服务器配置。</p><h3 id=配置系统>配置系统</h3><ul><li><p>配置 ssh-key：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>mkdir</span> -p ~/.ssh<br>nano ~/.ssh/authorized_keys<br></code></pre></td></tr></tbody></table></figure><p>将通过各种方法（如 Xshell、PuTTy 等软件）生成的 ssh-rsa 公钥粘贴入其中。随后通过 ssh-key 密钥方式登录。</p><p>为了安全，官方推荐将 ssh 密码登录方式关闭（不影响通过 VNC、DigitalOcean Console 等方式登录，<strong>请确保此时你的 SSH 是依靠密钥而不是密码登录，否则你设置完毕后会被踢出去</strong>）：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">nano /etc/ssh/sshd_config<br></code></pre></td></tr></tbody></table></figure><p>找到 <code>PasswordAuthentication</code> 一行，将其前面的 #删掉（取消注释），在后面将 yes 改成 no。</p><p>重启 sshd：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">systemctl restart sshd<br></code></pre></td></tr></tbody></table></figure></li><li><p>安装常用命令：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">apt update &amp;&amp; apt install wget rsync python git curl vim git ufw -y<br></code></pre></td></tr></tbody></table></figure></li><li><p>配置 SWAP，具体请参考<a target=_blank rel=noopener href=https://www.digitalocean.com/community/tutorials/how-to-add-swap-space-on-ubuntu-16-04>配置 SWAP 教程</a>。</p><p>请让你的内存 + SWAP 至少达到 4G 以上。可以在 root 用户下通过 <code>free -h</code> 查看。</p></li><li><p>配置防火墙</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash">sudo ufw allow OpenSSH<br>sudo ufw <span class=hljs-built_in>enable</span><br></code></pre></td></tr></tbody></table></figure><p>打开防火墙，随后打开 80 和 443 端口：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash">sudo ufw allow http<br>sudo ufw allow https<br></code></pre></td></tr></tbody></table></figure><p>然后可以通过 <code>sudo ufw status</code> 检查防火墙状态，你应该会看到 80 和 443 端口的显示。</p></li></ul><h3 id=安装docker和docker-compose>安装 docker 和 docker-compose</h3><p>注意：这里第一步使用了官方提供的一键脚本安装 docker。如果你对此感到不放心，请通过<a target=_blank rel=noopener href=https://docs.docker.com/engine/install/ubuntu/ >官网步骤</a>自行安装，同样也是复制粘贴命令行。</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><code class="hljs bash">bash &lt;(curl -L https://get.docker.com/)<br>sudo curl -L <span class=hljs-string>"https://github.com/docker/compose/releases/download/1.27.4/docker-compose-<span class=hljs-subst>$(uname -s)</span>-<span class=hljs-subst>$(uname -m)</span>"</span> -o /usr/local/bin/docker-compose<br>sudo <span class=hljs-built_in>chmod</span> +x /usr/local/bin/docker-compose<br></code></pre></td></tr></tbody></table></figure><h3 id=拉取Mastodon镜像（2022-04-25修改>拉取 Mastodon 镜像（2022-04-25 修改)</h3><ul><li><p>拉取镜像</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>mkdir</span> -p /home/mastodon/mastodon<br><span class=hljs-built_in>cd</span> /home/mastodon/mastodon<br>docker pull tootsuite/mastodon:latest     <span class=hljs-comment>#如果需要升级到某稳定版本，请将latest改成v3.5.1等版本号。</span><br>wget https://raw.githubusercontent.com/tootsuite/mastodon/master/docker-compose.yml<br></code></pre></td></tr></tbody></table></figure></li><li><p>修改 <code>docker-compose.yml</code> 配置文件</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">nano docker-compose.yml<br></code></pre></td></tr></tbody></table></figure><p>依次找到 <code>web</code>、<code>streaming</code>、<code>sidekiq</code> 分类，在每一类的 <code>image: tootsuite/mastodon</code> 后添加<code>:latest</code> 或者你刚才拉取的版本号，变成 <code>image: tootsuite/mastodon:latest</code> 或 <code>image: tootsuite/mastodon:v3.5.1</code> 等等。</p><p>此外，官方的 <code>docker-compose.yml</code> 文件里写的是 7.17.4，但目前 elasticsearch 的最高版本为 7.10.2，需要修改。</p><p><code>ctrl+X</code> 退出保存。</p></li></ul><h3 id=初始化PostgreSQL（2022-04-25修改）>初始化 PostgreSQL（2022-04-25 修改）</h3><blockquote><p>（在 v3.5.0 以后，请注意 Postgres 文件夹所在位置有所修改，从原本的 postgres 改为了 postgres14。本教程已更新。）</p></blockquote><p>刚才 <code>docker-compose.yml</code> 文件中，数据库（db）部分的地址为<code>./postgres14:/var/lib/postgresql/data</code>，因此你的数据库绝对地址为 <code>/home/mastodon/mastodon/postgres14</code>。</p><p>运行：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">docker run --name postgres14 -v /home/mastodon/mastodon/postgres14:/var/lib/postgresql/data -e   POSTGRES_PASSWORD=设置数据库管理员密码 --<span class=hljs-built_in>rm</span> -d postgres:14-alpine<br></code></pre></td></tr></tbody></table></figure><p>执行完后，检查 <code>/home/mastodon/mastodon/postgres14</code>，应该出现 postgres 相关的多个文件，不是空文件夹。</p><p>然后执行：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">docker <span class=hljs-built_in>exec</span> -it postgres14 psql -U postgres<br></code></pre></td></tr></tbody></table></figure><p>输入：</p><figure class="highlight sql"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs sql"><span class=hljs-keyword>CREATE</span> <span class=hljs-keyword>USER</span> mastodon <span class=hljs-keyword>WITH</span> PASSWORD <span class=hljs-string>'数据库密码（最好和数据库管理员密码不一样）'</span> CREATEDB;<br></code></pre></td></tr></tbody></table></figure><p>创建 mastodon 用户。</p><figure class="highlight sql"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs sql">\q<br></code></pre></td></tr></tbody></table></figure><p>退出数据库。</p><p>最后停止 docker：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">docker stop postgres14<br></code></pre></td></tr></tbody></table></figure><blockquote><p>附：如果你参考了 2020-12-12 之前的教程，那个教程未对 postgres 设置密码，有一定的安全隐患，请参考本文新增附录看如何设置密码。</p></blockquote><h3 id=配置Mastodon（2022-11-21修改>配置 Mastodon（2022-11-21 修改)</h3><ul><li><p>配置文件</p><p>在 <code>/home/mastodon/mastodon</code> 文件夹中创建空白<code>.env.production</code> 文件：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>touch</span> .env.production<br></code></pre></td></tr></tbody></table></figure><p>root 用户内，运行</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">docker-compose run --<span class=hljs-built_in>rm</span> web bundle <span class=hljs-built_in>exec</span> rake mastodon:setup<br></code></pre></td></tr></tbody></table></figure><p>随后会出现下列问题（此处参考<a target=_blank rel=noopener href=https://tech.konata.co/2022-02-10-build-a-mastodon/ >此方更新版教程</a>）：</p><p>Domain name: 你的域名</p><p>Single user mode disables registrations and redirects the landing page to your public profile.</p><p>Do you want to enable single user mode? No</p><p>Are you using Docker to run Mastodon? Yes</p><p>PostgreSQL host: mastodon_db_1</p><p>PostgreSQL port: 5432</p><p>Name of PostgreSQL database: mastodon</p><p>Name of PostgreSQL user: mastodon</p><p>Password of PostgreSQL user: （这里写上面你给 mastodon 设置的数据库密码）</p><p>Database configuration works! 🎆</p><p>Redis host: mastodon_redis_1</p><p>Redis port: 6379</p><p>Redis password: （这里是直接回车，没有密码）</p><p>Redis configuration works! 🎆</p><p>Do you want to store uploaded files on the cloud? 这个我们先填 No，未来再参考<a target=_blank rel=noopener href=https://pullopen.github.io/%E7%AB%99%E7%82%B9%E7%BB%B4%E6%8A%A4/2020/07/22/Move-mastodon-media-to-Scaleway.html>上云教程</a>配置。</p><p>Do you want to send e-mails from localhost? No，然后根据刚才配置的邮件服务填写（下文为举例）。</p><p>SMTP server: <a target=_blank rel=noopener href=http://smtp.zoho.eu>smtp.zoho.eu</a></p><p>SMTP port: 587</p><p>SMTP username: 你的 zoho 管理员邮箱地址</p><p>SMTP password: 你的 zoho 管理员密码</p><p>SMTP authentication: plain</p><p>SMTP OpenSSL verify mode: none</p><p>E-mail address to send e-mails “from”: 你的 zoho 管理员邮箱地址</p><p>Send a test e-mail with this configuration right now? no</p><p>This configuration will be written to .env.production</p><p>Save configuration? Yes</p><p>Below is your configuration, save it to an .env.production file outside Docker:</p><p>然后会出现.env.production 配置，<strong>请务必复制下来，先存到电脑里，等会儿要用。</strong></p><p>之后会要你建立数据库和编译，都选是。</p><p><strong>更新：在 4.0.2 版本，因为一些 bug，请先不要建立管理员帐号，稍后再使用 tootctl 工具建立！</strong></p><p>一切成功之后，记得<strong>立刻马上：</strong></p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">nano .env.production<br></code></pre></td></tr></tbody></table></figure><p>把你刚才复制下来的配置保存进去。</p><p><strong>更新：在 4.0.2 版本，需要在<code>.env.production</code> 中增加一行：</strong></p><figure class="highlight ini"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs ini"><span class=hljs-attr>REDIS_URL</span>=redis://@mastodon_redis_1:<span class=hljs-number>6379</span><br></code></pre></td></tr></tbody></table></figure></li><li><p>启动 Mastodon</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash">docker-compose down<br>docker-compose up -d<br></code></pre></td></tr></tbody></table></figure></li><li><p>为相应文件夹赋权</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>chown</span> 991:991 -R ./public<br><span class=hljs-built_in>chown</span> -R 70:70 ./postgres14<br>docker-compose down<br>docker-compose up -d<br></code></pre></td></tr></tbody></table></figure></li></ul><h3 id=安装并配置nginx（2022-11-21修改）>安装并配置 nginx（2022-11-21 修改）</h3><p>在这一步之前，请记得到您购买域名的网站（如 NameCheap），在 DNS 设置中添加一个 <strong>A Record</strong>，Host 填写 @（如果没有子域名需求），Value 填写你服务器的 IP 地址，将你设定的域名指向你的服务器。</p><p><strong>请注意：此时你的 DNS Setting 里除了你刚才在邮箱配置和本步骤中亲自设置的内容之外，别的任何由域名商自动生成的内容请都删光。</strong></p><ul><li><p>安装 nginx</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">sudo apt install nginx -y<br></code></pre></td></tr></tbody></table></figure></li><li><p>配置 nginx</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">nano /etc/nginx/sites-available/你的域名<br></code></pre></td></tr></tbody></table></figure><p>网页打开 <a target=_blank rel=noopener href=https://raw.githubusercontent.com/mastodon/mastodon/main/dist/nginx.conf>nginx 模板</a>，将其中的 example.com 替换成自己域名，将 20 和 43 行的 <code>/home/mastodon/live/public</code> 改成 <code>/home/mastodon/mastodon/public</code>，** 更新：** 并将 <code>try_files $uri =404;</code> 修改为 <code>try_files $uri @proxy;</code>，复制到服务器中保存。</p><p>随后配置镜像文件</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>ln</span> -s /etc/nginx/sites-available/你的域名 /etc/nginx/sites-enabled/<br></code></pre></td></tr></tbody></table></figure><p><code>nginx -t</code> 检查，无误后重启（如果提示 ssl 证书问题，请在 <code>listen 443 ssl http2;</code>、<code>listen [::]:443 ssl http2;</code> 等包含 ssl 的行前加 #号先行注释掉，配置完 ssl 证书后再改回来）：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">systemctl reload nginx<br></code></pre></td></tr></tbody></table></figure></li><li><p>配置 SSL 证书</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><code class="hljs bash">apt install snapd<br>sudo snap install core; sudo snap refresh core<br>sudo snap install --classic certbot<br>sudo <span class=hljs-built_in>ln</span> -s /snap/bin/certbot /usr/bin/certbot<br>sudo certbot certonly --nginx -d 你的域名<br></code></pre></td></tr></tbody></table></figure></li><li><p>重启 nginx</p><p>重新打开 nginx 配置文件，将 <code>ssl_certificate</code> 和 <code>ssl_certificate_key</code> 两行前的 #号（以及你刚才添加的 #号）删除。</p><p><code>nginx -t</code> 检查是否有错误。</p><p>如果没有错误，则可重启 nginx：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">systemctl reload nginx<br></code></pre></td></tr></tbody></table></figure></li><li><p>检查证书更新</p><p>最后，可通过</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">certbot renew --dry-run<br></code></pre></td></tr></tbody></table></figure><p>检查证书是否能自动更新。</p></li></ul><p>如果不放心，可以再至 <code>/home/mastodon/mastodon</code> 文件夹，运行 <code>docker-compose up -d</code> 重启 mastodon。静静等待几分钟后，点开你的域名，你的站点就上线啦！</p><blockquote><p>更新：此时可通过 tootctl 工具建立管理员帐户</p></blockquote><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">docker <span class=hljs-built_in>exec</span> mastodon_web_1 tootctl accounts create USERNAME --email EMAIL --confirmed --role Owner　　<br></code></pre></td></tr></tbody></table></figure><h2 id=站点上线之后>站点上线之后</h2><p>在站点上线之后，你可以：</p><h3 id=开启全文搜索>开启全文搜索</h3><p>Docker 的全文搜索开启十分方便，只需要：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>cd</span> /home/mastodon/mastodon<br>nano docker-compose.yml<br></code></pre></td></tr></tbody></table></figure><p>编辑 <code>docker-compose.yml</code>，去掉 <code>es</code> 部分前所有的 #号，并且去掉 <code>web</code> 部分中 <code>es</code> 前面的 #号。</p><p><code>nano .env.production</code> 编辑<code>.env.production</code> 文件，加上</p><figure class="highlight ini"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><code class="hljs ini"><span class=hljs-attr>ES_ENABLED</span>=<span class=hljs-literal>true</span><br><span class=hljs-attr>ES_HOST</span>=es<br><span class=hljs-attr>ES_PORT</span>=<span class=hljs-number>9200</span><br></code></pre></td></tr></tbody></table></figure><p>三行，重启：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash">docker-compose down<br>docker-compose up -d<br></code></pre></td></tr></tbody></table></figure><p>待文件夹中出现 elasticsearch 文件夹后，赋权：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>chown</span> 1000:1000 -R elasticsearch<br></code></pre></td></tr></tbody></table></figure><p>再次重启：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash">docker-compose down<br>docker-compose up -d<br></code></pre></td></tr></tbody></table></figure><p>全文搜索即搭建完成。</p><p>然后</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">docker-compose run --<span class=hljs-built_in>rm</span> web bin/tootctl search deploy<br></code></pre></td></tr></tbody></table></figure><p>建立之前嘟文的搜索索引即可。</p><h3 id=修改配置文件>修改配置文件</h3><p>如果在之后需要再对.env.production 配置进行修改，只需：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>cd</span> /home/mastodon/mastodon<br>nano .env.production<br></code></pre></td></tr></tbody></table></figure><p>进行相应修改，然后</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash">docker-compose down<br>docker-compose up -d<br></code></pre></td></tr></tbody></table></figure><p>重启即可。</p><h3 id=使用管理命令行>使用管理命令行</h3><p>在 docker 中使用 <a target=_blank rel=noopener href=https://docs.joinmastodon.org/admin/tootctl/ >tootctl 管理命令行</a>的方式有三种：</p><ul><li><p>进入 docker 系统后操作</p><p><code>docker ps</code> 查看你的容器名字，如果你按照刚才设置，那你的容器名字一般为 mastodon_web_1。</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>cd</span> /home/mastodon/mastodon<br>docker <span class=hljs-built_in>exec</span> -it mastodon_web_1 /bin/bash    <span class=hljs-comment>#或者将“mastodon_web_1”替换为你的容器名。</span><br></code></pre></td></tr></tbody></table></figure><p>进入 docker 系统 mastodon 用户，然后在其中进行相应的 tootctl 操作。</p><p>注：如果需要进入 docker 系统的 root 用户进行一些软件安装，则需输入 <code>docker exec --user root -it mastodon_web_1 /bin/bash</code>。</p></li><li><p>在 /home/mastodon/mastodon 文件夹操作</p><p>首先进入 /home/mastodon/mastodon，然后</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">docker-compose run --<span class=hljs-built_in>rm</span> web bin/tootctl 具体命令<br></code></pre></td></tr></tbody></table></figure><p>进行操作。</p></li><li><p>在任意位置操作</p><p>在任意位置：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">docker <span class=hljs-built_in>exec</span> mastodon_web_1 tootctl 具体命令<br></code></pre></td></tr></tbody></table></figure><p>需要注意的是，这则具体命令需要包括所有必须的参数，并且如果命令本身会要求你进行后续输入，则无法完成（比如 self-distruct 命令无法通过该步骤完成。）</p></li><li><p>使用脚本简化命令</p><p>可参考<a target=_blank rel=noopener href=https://blog.tantalum.life/posts/how-to-run-your-mastodon-by-docker/#%E4%BD%BF%E7%94%A8alias%E8%84%9A%E6%9C%AC%E7%BC%A9%E5%86%99tootctl%E5%91%BD%E4%BB%A4>这篇文章</a>：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>cd</span> /home/mastodon/mastodon<br>nano tootctl.sh<br></code></pre></td></tr></tbody></table></figure><p>编辑脚本内容为：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-meta>#!/bin/bash</span><br>lpwd=<span class=hljs-variable>$PWD</span><br>mypath=`<span class=hljs-built_in>dirname</span> <span class=hljs-variable>$0</span>`<br><span class=hljs-built_in>cd</span> <span class=hljs-variable>$mypath</span><br><span class=hljs-keyword>if</span> [ <span class=hljs-variable>$#</span> -ge 1 ]<br><span class=hljs-keyword>then</span><br>    <span class=hljs-keyword>case</span> <span class=hljs-variable>$1</span> <span class=hljs-keyword>in</span> <br>    	<span class=hljs-string>"restart"</span><br>    		docker-compose restart<br>    	;;<br>    	<span class=hljs-string>"reload"</span>)<br>    		docker-compose down &amp;&amp; docker-compose up -d<br>    	;;<br>		<span class=hljs-string>"stop"</span>)<br>    		docker-compose down<br>    	;;<br>		<span class=hljs-string>"start"</span>)<br>    		docker-compose up -d<br>    	;;<br>    	<span class=hljs-string>"psql"</span>)<br>    		docker-compose <span class=hljs-built_in>exec</span> db $*<br>    	;;<br>    	*)<br>    		docker-compose run --<span class=hljs-built_in>rm</span> web bin/tootctl $*<br>    	;;<br>	<span class=hljs-keyword>esac</span><br><span class=hljs-keyword>else</span><br>	<span class=hljs-built_in>echo</span> <span class=hljs-string>"please use tootctl help for help"</span><br><span class=hljs-keyword>fi</span><br><span class=hljs-built_in>cd</span> <span class=hljs-variable>$lpwd</span><br></code></pre></td></tr></tbody></table></figure><p>随后执行：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>chmod</span> +x /home/mastodon/mastodon/tootctl.sh<br><span class=hljs-built_in>echo</span> <span class=hljs-string>"alias tootctl='/home/mastodon/mastodon/tootctl.sh' "</span> &gt;&gt; ~/.bashrc <br><span class=hljs-built_in>source</span> ~/.bashrc<br></code></pre></td></tr></tbody></table></figure><p>之后 tootctl 相关命令均可在进入 <code>/home/mastodon/mastodon/</code> 后缩写为 <code>tootctl xxx</code>，且数据库相关命令也可通过 <code>tootctl psql</code> 进入。</p></li></ul><h3 id=定时清理媒体文件>定时清理媒体文件</h3><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">crontab -e<br></code></pre></td></tr></tbody></table></figure><p>选择编辑器为 nano 或者你习惯的编辑器，随后输入：</p><figure class="highlight shell"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><code class="hljs shell">20 03    * * 1   docker exec mastodon_web_1 tootctl media remove-orphans<br>20 04    * * 2   docker exec mastodon_web_1 tootctl media remove --days=7<br>20 05    * * 3   docker exec mastodon_web_1 tootctl preview_cards remove<br></code></pre></td></tr></tbody></table></figure><p>具体清理时间可以自己设置（参考 <a target=_blank rel=noopener href=https://www.runoob.com/w3cnote/linux-crontab-tasks.html>Crontab 教程</a>，上述表示在<strong>服务器时间</strong>周一 / 二 / 三相应时间执行媒体清理命令。</p><h3 id=升级>升级</h3><p>如果你要升级到最新版本，只需要：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>cd</span> /home/mastodon/mastodon<br>docker pull tootsuite/mastodon:latest     <span class=hljs-comment>#或者将latest改成版本号如v3.2.1</span><br></code></pre></td></tr></tbody></table></figure><p>如果你升级的是特定版本，则需要编辑 docker-compose.yml，将 web、streaming、sidekiq 三部分的版本号改成相应版本。如果是 latest 则无需改动。</p><p>然后</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">docker-compose up -d<br></code></pre></td></tr></tbody></table></figure><p>启动。</p><p>如果官方升级提示中包括其他步骤如 <code>docker-compose run --rm web rails db:migrate</code>，则可在启动后进行。</p><p>在确认升级没问题之后，运行</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">docker system prune -a<br></code></pre></td></tr></tbody></table></figure><p>清除旧的 docker 镜像文件。</p><h3 id=如果在操作过程中出现了任何问题……>如果在操作过程中出现了任何问题……</h3><p>如果没有对站点进行过魔改，只要在 docker 系统外，通过</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash">docker-compose down<br>docker-compose up -d<br></code></pre></td></tr></tbody></table></figure><p>让系统通过 docker 镜像重新搭建容器即可。</p><h3 id=利用Scaleway备份数据库>利用 Scaleway 备份数据库</h3><p>本步脚本由兔子写就，感谢 ta！</p><p>首先，请注册 Scaleway，申请 token，创建 Bucket，此三步可参考 <a target=_blank rel=noopener href=https://pullopen.github.io/%E7%AB%99%E7%82%B9%E7%BB%B4%E6%8A%A4/2020/07/22/Move-mastodon-media-to-Scaleway.html>Scaleway 上云教程</a>。</p><p>注意：下文提到的备份脚本会自动删除 7 天以前的文件，因此 ** 请为备份数据库单独建立一个 bucket，** 不要和媒体文件使用同一个 bucket！</p><p>在服务器中安装 rclone 和 zip：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash">curl https://rclone.org/install.sh | sudo bash<br>apt install zip -y<br></code></pre></td></tr></tbody></table></figure><p>创建 rclone 配置文件夹</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>mkdir</span> -p  ~/.config/rclone/<br></code></pre></td></tr></tbody></table></figure><p>新建配置文件：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">nano ~/.config/rclone/rclone.conf<br></code></pre></td></tr></tbody></table></figure><p>填入下列内容：</p><figure class="highlight ini"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><code class="hljs ini"><span class=hljs-section>[scaleway]</span><br><span class=hljs-attr>type</span> = s3<br><span class=hljs-attr>provider</span> = Scaleway<br><span class=hljs-attr>access_key_id</span> = 你的ACCESS KEY<br><span class=hljs-attr>secret_access_key</span> = 你的SECRET KEY<br><span class=hljs-attr>region</span> = nl-ams（根据你bucket选择的地区，法国fr-par，荷兰nl-ams，波兰pl-waw）<br><span class=hljs-attr>endpoint</span> = s3.nl-ams.scw.cloud  （同上）<br><span class=hljs-attr>acl</span> = private<br></code></pre></td></tr></tbody></table></figure><p>保存。</p><p>然后创建脚本</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">nano /backup.sh<br></code></pre></td></tr></tbody></table></figure><p>输入</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-meta>#!/bin/bash</span><br><span class=hljs-built_in>source</span> /etc/profile<br>now=$(<span class=hljs-built_in>date</span> <span class=hljs-string>"+%Y%m%d-%H%M%S"</span>)<br>origin=<span class=hljs-string>"/home/mastodon/mastodon"</span><br>target=<span class=hljs-string>"scaleway:你的bucket名字"</span><br><span class=hljs-built_in>echo</span> `<span class=hljs-built_in>date</span> +<span class=hljs-string>"%Y-%m-%d %H:%M:%S"</span>` <span class=hljs-string>" now starting export"</span><br>/usr/bin/docker <span class=hljs-built_in>exec</span> pg容器名 pg_dump -U postgres -Fc mastodon_production &gt; <span class=hljs-variable>${origin}</span>/backup.dump &amp;&amp;<br><span class=hljs-built_in>echo</span> `<span class=hljs-built_in>date</span> +<span class=hljs-string>"%Y-%m-%d %H:%M:%S"</span>` <span class=hljs-string>" succeed and upload to s3 now"</span><br>/usr/bin/zip -P 密码 <span class=hljs-variable>${origin}</span>/backup_<span class=hljs-variable>${now}</span>.zip <span class=hljs-variable>${origin}</span>/backup.dump &amp;&amp;<br>/usr/bin/rclone copy <span class=hljs-variable>${origin}</span>/backup_<span class=hljs-variable>${now}</span>.zip <span class=hljs-variable>${target}</span> &amp;&amp;<br><span class=hljs-built_in>echo</span> `<span class=hljs-built_in>date</span> +<span class=hljs-string>"%Y-%m-%d %H:%M:%S"</span>` <span class=hljs-string>" ok all done"</span><br><span class=hljs-built_in>rm</span> -f <span class=hljs-variable>${origin}</span>/backup.dump <span class=hljs-variable>${origin}</span>/backup_<span class=hljs-variable>${now}</span>.zip<br>/usr/bin/rclone --min-age 7d  delete <span class=hljs-variable>${target}</span><br></code></pre></td></tr></tbody></table></figure><p>pg 容器名一般为 mastodon_db_1（通过 docker ps 查看），密码为你设立的解压密码。mastodon_production 为你的数据库名，可至<code>.env.production</code> 查看。</p><p>保存。</p><p>赋权：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>chmod</span> 751 /backup.sh<br></code></pre></td></tr></tbody></table></figure><p>然后，</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">/backup.sh<br></code></pre></td></tr></tbody></table></figure><p>试运行一下，看看 Scaleway 中有没有 zip 文件生成。如果出现 zip 文件且大小以 mb 计算，则成功。</p><p>之后如果想通过备份文件恢复，则可参考<a target=_blank rel=noopener href=https://pullopen.github.io/%E7%AB%99%E7%82%B9%E7%BB%B4%E6%8A%A4/2020/10/21/migrate-Mastodon-to-Docker.html>迁移教程</a>。</p><p>随后，设置定时任务：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">crontab -e<br></code></pre></td></tr></tbody></table></figure><p>选择 nano 编辑器，</p><figure class="highlight shell"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs shell">3 22    * * *   /backup.sh &gt;&gt; /backup.log<br></code></pre></td></tr></tbody></table></figure><p>具体时间自己设置，建议设置在半夜，注意服务器时区（通过 <code>date</code> 查看服务器时间）。</p><h3 id=利用Cloudflare提升网站速度>利用 Cloudflare 提升网站速度</h3><p>请注意，Cloudflare 目前在大陆也时常被阻拦，未必能起到加速作用。是否能提高速度，需要根据服务器本身的在大陆的连接速度判断。</p><p>步骤如下：</p><p>到 <a target=_blank rel=noopener href=https://www.cloudflare.com/ >Cloudflare 官网</a>注册账号，选择 Add Website 输入你自己的域名，Cloudflare 会自动读取你的 DNS 记录并且要求你修改域名服务器（NameServer）。如果你是 NameCheap 上购买的域名，则点开你的域名，在 Domain 那一栏下面选择 Custom DNS，填入 Cloudflare 提供的两个 NameServer，静静等待生效即可。如果是其他地方购买的域名，Cloudflare 也提供了相应<a target=_blank rel=noopener href=https://support.cloudflare.com/hc/zh-cn/articles/205195708-%E5%B0%86%E6%82%A8%E7%9A%84%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9B%B4%E6%94%B9%E4%B8%BA-Cloudflare>教程</a>，通常非常简单就能完成。</p><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2020/07/22/U7oZrR.png alt=NameCheap设置 data-caption=NameCheap设置 loading=lazy></p><p>生效之后会有邮件通知，这时打开 Cloudflare，进入你的域名。</p><p>点开 “速度 / Speed - 优化”，下图 Auto Minify 的三个勾勾请勿选上。</p><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2020/07/22/U7TYpF.png alt=AutoMinify data-caption=AutoMinify loading=lazy></p><blockquote><p>注意（2020-12-01 更新）：Auto Minify 在 3.3.0 版本之后会影响网页打开，请勿勾选！</p></blockquote><p>同时<strong>请注意</strong>，<strong>Rocket Loader™</strong>这个开关，请务必确保它<strong>关闭</strong>，否则你的 Mastodon 会变成白屏。</p><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2020/07/22/U7T79S.png alt=RocketLoader data-caption=RocketLoader loading=lazy></p><p>打开 <strong>SSL 设置</strong>，将模式改成 Full / 完全：</p><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2020/07/23/UXkujS.png alt=SSLSetting data-caption=SSLSetting loading=lazy></p><p>现在请打开测试，您的网站速度有没有变快？每个人每个地区情况可能不同，对我而言确实有肉眼可见的速度提升，对于各位可能需要测试。如果速度反而变慢，可以直接在 Cloudflare 的 DNS 设定中将橘色的云朵按灰，即可取消代理。</p><p>更详细的设置可以参见 <strong><a target=_blank rel=noopener href=https://guide.mastodon.im/cloudflare>O3O 搭站指南</a></strong>。</p><h3 id=附：如何修改数据库密码（2022-04-25更新）>附：如何修改数据库密码（2022-04-25 更新）</h3><p>如果在 2020-12-12 前参考本教程，当时本教程未要求大家设置数据库密码，这样做有一定的安全风险。因此，如果你<strong>已经建站完毕且未设置数据库密码</strong>，请参考本段添加数据库密码。</p><p>关闭 mastodon 服务：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">docker-compose down<br></code></pre></td></tr></tbody></table></figure><p><code>nano docker-compose.yml</code> 修改，将之前教程要求你设置的</p><figure class="highlight yaml"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs yaml"><span class=hljs-attr>environment:</span><br>  <span class=hljs-bullet>-</span> <span class=hljs-string>POSTGRES_HOST_AUTH_METHOD=trust</span><br></code></pre></td></tr></tbody></table></figure><p>删掉，保存。</p><p><code>nano .env.production</code> 修改，添加</p><figure class="highlight ini"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs ini"><span class=hljs-attr>DB_PASS</span>=数据库密码<br></code></pre></td></tr></tbody></table></figure><p>保存。</p><p>启动数据库并进入 psql 模式：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash">docker run --name postgres14 -v /home/mastodon/mastodon/postgres14:/var/lib/postgresql/data --<span class=hljs-built_in>rm</span>  -d  postgres:14-alpine<br>docker <span class=hljs-built_in>exec</span> -it postgres14 psql -U postgres<br></code></pre></td></tr></tbody></table></figure><p>填入：</p><figure class="highlight sql"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><code class="hljs sql"><span class=hljs-keyword>alter</span> <span class=hljs-keyword>user</span> mastodon <span class=hljs-keyword>with</span> password <span class=hljs-string>'数据库密码'</span>;<br><span class=hljs-keyword>alter</span> <span class=hljs-keyword>user</span> postgres <span class=hljs-keyword>with</span> password <span class=hljs-string>'数据库管理员密码（两者最好不要相同）'</span>;<br>\q<br></code></pre></td></tr></tbody></table></figure><p>停止数据库运行并启动 mastodon：</p><figure class="highlight bash"><table><tbody><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash">docker stop postgres14<br>docker-compose up -d<br></code></pre></td></tr></tbody></table></figure><p>数据库管理员密码和数据库密码即添加完毕。</p><h2 id=总结>总结</h2><p>以上就是从头通过 Docker 搭建 Mastodon 的方法，通过单纯复制粘贴很快就能搭建出来。在升级过程中也能免去编译过程对小机器造成的负担。（当然，SWAP 还是要开的！）如果使用官方分支，升级只要几分钟。</p><p>目前网络上一些其他的 docker 搭建指南都提到需要 docker-compose build 这一步骤，并无必要，且耗时长、对服务器压力大。</p><p>然后有朋友就要问了：我之前是按照 DigitalOcean 一键镜像搭建的 / 用官方文档命令行搭建的，怎么迁移到 docker 上去呢？如果我想对代码进行一点改动要怎么做呢？这些问题，我们将在后续的文章中谈到。</p></article><div class=nexmoe-post-copyright><strong>本文作者：</strong>Shiux<br><strong>本文链接：</strong><a href=https://blog.shiux.com/article/using-docker-to-build-mastodon/ title=https:&#x2F;&#x2F;blog.shiux.com&#x2F;article&#x2F;using-docker-to-build-mastodon&#x2F; target=_blank rel=noopener>https:&#x2F;&#x2F;blog.shiux.com&#x2F;article&#x2F;using-docker-to-build-mastodon&#x2F;</a><br><strong>版权声明：</strong>本文采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh target=_blank>CC BY-NC-SA 3.0 CN</a> 协议进行许可</div><div class="nexmoe-post-meta nexmoe-rainbow"><a class="nexmoefont icon-tag-fill -none-link" href=/tags/Docker/ rel=tag>Docker</a></div><div class=nexmoe-post-footer><script src=https://giscus.app/client.js data-repo=fungyua/blog-comments data-repo-id="MDEwOlJlcG9zaXRvcnk0MDQ0NTY2OTQ=" data-category=Comments data-category-id=DIC_kwDOGBuE9s4CTUfb data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></div></div></div><div class=nexmoe-post-right><div class=nexmoe-fixed><div class=nexmoe-tool><button class="mdui-fab catalog" style=overflow:unset><i class="nexmoefont icon-i-catalog"></i><div class=nexmoe-toc><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BC%80%E5%A7%8B%E4%BD%BF%E7%94%A8Docker%E6%90%AD%E5%BB%BA%E5%AE%9E%E4%BE%8B><span class=toc-number>1.</span> <span class=toc-text>为什么开始使用 Docker 搭建实例</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BC%98%E7%82%B9><span class=toc-number>1.1.</span> <span class=toc-text>优点</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%BC%BA%E7%82%B9><span class=toc-number>1.2.</span> <span class=toc-text>缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E5%A6%82%E4%BD%95%E5%9C%A8Docker%E4%B8%8A%E4%BB%8E%E5%A4%B4%E6%90%AD%E5%BB%BAMastodon><span class=toc-number>2.</span> <span class=toc-text>如何在 Docker 上从头搭建 Mastodon</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%B4%AD%E4%B9%B0%E5%9F%9F%E5%90%8D%E3%80%81%E8%B4%AD%E4%B9%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%81%E9%85%8D%E7%BD%AESMTP%E6%9C%8D%E5%8A%A1><span class=toc-number>2.1.</span> <span class=toc-text>购买域名、购买服务器、配置 SMTP 服务</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E9%85%8D%E7%BD%AE%E7%B3%BB%E7%BB%9F><span class=toc-number>2.2.</span> <span class=toc-text>配置系统</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%AE%89%E8%A3%85docker%E5%92%8Cdocker-compose><span class=toc-number>2.3.</span> <span class=toc-text>安装 docker 和 docker-compose</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%8B%89%E5%8F%96Mastodon%E9%95%9C%E5%83%8F%EF%BC%882022-04-25%E4%BF%AE%E6%94%B9><span class=toc-number>2.4.</span> <span class=toc-text>拉取 Mastodon 镜像（2022-04-25 修改)</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%88%9D%E5%A7%8B%E5%8C%96PostgreSQL%EF%BC%882022-04-25%E4%BF%AE%E6%94%B9%EF%BC%89><span class=toc-number>2.5.</span> <span class=toc-text>初始化 PostgreSQL（2022-04-25 修改）</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E9%85%8D%E7%BD%AEMastodon%EF%BC%882022-11-21%E4%BF%AE%E6%94%B9><span class=toc-number>2.6.</span> <span class=toc-text>配置 Mastodon（2022-11-21 修改)</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEnginx%EF%BC%882022-11-21%E4%BF%AE%E6%94%B9%EF%BC%89><span class=toc-number>2.7.</span> <span class=toc-text>安装并配置 nginx（2022-11-21 修改）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E7%AB%99%E7%82%B9%E4%B8%8A%E7%BA%BF%E4%B9%8B%E5%90%8E><span class=toc-number>3.</span> <span class=toc-text>站点上线之后</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%BC%80%E5%90%AF%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2><span class=toc-number>3.1.</span> <span class=toc-text>开启全文搜索</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6><span class=toc-number>3.2.</span> <span class=toc-text>修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BD%BF%E7%94%A8%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4%E8%A1%8C><span class=toc-number>3.3.</span> <span class=toc-text>使用管理命令行</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%AE%9A%E6%97%B6%E6%B8%85%E7%90%86%E5%AA%92%E4%BD%93%E6%96%87%E4%BB%B6><span class=toc-number>3.4.</span> <span class=toc-text>定时清理媒体文件</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%8D%87%E7%BA%A7><span class=toc-number>3.5.</span> <span class=toc-text>升级</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%A6%82%E6%9E%9C%E5%9C%A8%E6%93%8D%E4%BD%9C%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%87%BA%E7%8E%B0%E4%BA%86%E4%BB%BB%E4%BD%95%E9%97%AE%E9%A2%98%E2%80%A6%E2%80%A6><span class=toc-number>3.6.</span> <span class=toc-text>如果在操作过程中出现了任何问题……</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%88%A9%E7%94%A8Scaleway%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE%E5%BA%93><span class=toc-number>3.7.</span> <span class=toc-text>利用 Scaleway 备份数据库</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%88%A9%E7%94%A8Cloudflare%E6%8F%90%E5%8D%87%E7%BD%91%E7%AB%99%E9%80%9F%E5%BA%A6><span class=toc-number>3.8.</span> <span class=toc-text>利用 Cloudflare 提升网站速度</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E9%99%84%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%86%E7%A0%81%EF%BC%882022-04-25%E6%9B%B4%E6%96%B0%EF%BC%89><span class=toc-number>3.9.</span> <span class=toc-text>附：如何修改数据库密码（2022-04-25 更新）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%80%BB%E7%BB%93><span class=toc-number>4.</span> <span class=toc-text>总结</span></a></li></ol></div></button> <a href=#nexmoe-content class=toc-link aria-label="Back To Top" title=top><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a></div></div></div></div><div id=nexmoe-search-space><div class=search-container><div class=search-header><div class=search-input-container><input class=search-input type=text placeholder=搜索 oninput=sinput()></div><a class=search-close onclick=sclose()>×</a></div><div class=search-body></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MEQVE108T"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-9MEQVE108T")</script></body></html>